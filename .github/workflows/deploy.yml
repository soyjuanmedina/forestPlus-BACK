name: Build and Deploy Spring Boot WAR to Tomcat (FTPS)

on:
  push:
    branches:
      - master  # O "main" si tu rama principal se llama as√≠

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Descargar el c√≥digo del repositorio
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Instalar Java 21 (Temurin es el m√°s estable y recomendado)
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      # 3Ô∏è‚É£ Compilar y empaquetar el WAR
      - name: Build WAR with Maven
        run: mvn clean package -DskipTests

      # 4Ô∏è‚É£ Renombrar el WAR a ROOT.war (si tu hosting despliega autom√°ticamente ese nombre)
      - name: Rename WAR file to ROOT.war
        run: |
          WAR_FILE=$(ls target/*.war | head -n 1)
          BASENAME=$(basename "$WAR_FILE")
          if [ "$BASENAME" != "ROOT.war" ]; then
            mv "$WAR_FILE" target/ROOT.war
          else
            echo "WAR already named ROOT.war, skipping rename"
          fi

      # 5Ô∏è‚É£ Verificar que el archivo est√© listo
      - name: List target folder
        run: ls -la target/

      # 6Ô∏è‚É£ Subir solo ROOT.war a tu servidor por FTPS
      - name: Upload ROOT.war via FTPS
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}        # üëà c√°mbialo o usa secreto
          username: ${{ secrets.FTP_USERNAME }}    # üëà c√°mbialo o usa secreto
          password: ${{ secrets.FTP_PASSWORD }}
          port: 21                                 # o 990 si tu FTPS usa ese
          protocol: ftps
          local-dir: target/
          server-dir: appservers/apache-tomcat-10x/webapps/  # üëà ajusta a tu ruta real
          log-level: verbose
          timeout: 10m
          exclude: |
            *
            !ROOT.war
