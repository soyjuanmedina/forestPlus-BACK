import{b as Z,d as Ce,e as ge,g as ve,h as be,i as A,j as Ee,k as we,l as Se}from"./chunk-XNMPSWT4.js";import{$ as s,A as b,Ba as E,Bc as ae,C as j,Cc as se,Dc as de,Ea as C,Ec as le,F as W,Fc as me,Ga as l,Gc as ce,Hc as pe,Ic as ue,J as $,Jc as fe,Kc as he,Lc as _e,Mc as xe,P as p,Q as u,Ra as a,Sa as B,Ta as x,Wa as w,Xa as S,Ya as F,_ as P,_a as L,aa as v,ab as T,cb as N,f as k,i as V,ia as y,kb as G,lb as U,lc as Q,ma as c,mb as q,oc as X,p as D,pb as z,qb as H,rd as ye,s as I,sc as ee,uc as te,va as r,vc as ie,wa as n,wc as ne,xa as _,xb as J,yc as oe,zb as K,zc as re}from"./chunk-PPGGN6NP.js";var Fe=(()=>{class d{constructor(e){this.co2Api=e}getAll(e){return this.co2Api.getAll(e)}save(e,t){return this.co2Api.createOrUpdate(e,t)}delete(e,t){return this.co2Api._delete(e,t)}static{this.\u0275fac=function(t){return new(t||d)(W(Q))}}static{this.\u0275prov=j({token:d,factory:d.\u0275fac,providedIn:"root"})}}return d})();function Te(d,g){if(d&1){let e=E();r(0,"div",39)(1,"div")(2,"label",40),a(3,"Emitido"),n(),r(4,"input",41),F("ngModelChange",function(i){p(e);let o=l(3);return S(o.co2Years[0].editEmissions,i)||(o.co2Years[0].editEmissions=i),u(i)}),n()(),r(5,"div")(6,"label",40),a(7,"Compensado"),n(),r(8,"input",41),F("ngModelChange",function(i){p(e);let o=l(3);return S(o.co2Years[0].editCompensations,i)||(o.co2Years[0].editCompensations=i),u(i)}),n()(),r(9,"button",24),C("click",function(){p(e);let i=l(3);return u(i.saveCO2(i.co2Years[0]))}),a(10," Guardar "),n()()}if(d&2){let e=l(3);s(4),w("ngModel",e.co2Years[0].editEmissions),s(4),w("ngModel",e.co2Years[0].editCompensations)}}function Ne(d,g){if(d&1){let e=E();r(0,"div",39)(1,"div")(2,"label",40),a(3,"Emitido"),n(),r(4,"input",41),F("ngModelChange",function(i){p(e);let o=l().$implicit;return S(o.editEmissions,i)||(o.editEmissions=i),u(i)}),n()(),r(5,"div")(6,"label",40),a(7,"Compensado"),n(),r(8,"input",41),F("ngModelChange",function(i){p(e);let o=l().$implicit;return S(o.editCompensations,i)||(o.editCompensations=i),u(i)}),n()(),r(9,"button",24),C("click",function(){p(e);let i=l().$implicit,o=l(3);return u(o.saveCO2(i))}),a(10," Guardar "),n()()}if(d&2){let e=l().$implicit;s(4),w("ngModel",e.editEmissions),s(4),w("ngModel",e.editCompensations)}}function Ae(d,g){if(d&1){let e=E();r(0,"div",42)(1,"h3",27),a(2),n(),r(3,"div",28)(4,"button",29),C("click",function(){let i=p(e).$implicit,o=l(3);return u(o.toggleEditCO2(i))}),a(5),n()(),y(6,Ne,11,2,"div",30),r(7,"div",31)(8,"div",32)(9,"div",33),a(10,"Emitido"),n(),_(11,"canvas",43),n(),r(12,"div",32)(13,"div",33),a(14,"Compensado"),n(),_(15,"canvas",43),n(),r(16,"div",32)(17,"div",44),a(18),T(19,"number"),n(),r(20,"div",45),a(21,"Toneladas de CO\u2082"),n(),r(22,"div",46),a(23),n()()()()}if(d&2){let e=g.$implicit,t=l(3);s(2),x("A\xF1o ",e.year,""),s(3),x(" ",e.editMode?"Cancelar":"Editar"," "),s(),c("ngIf",e.editMode),s(5),c("id",e.emitidoRef),s(4),c("id",e.compensadoRef),s(2),c("ngClass",t.getNetColorClass(e.totalEmissions,e.totalCompensations)),s(),x(" ",N(19,8,e.totalEmissions-e.totalCompensations,"1.0-0")," "),s(5),x(" (",t.getCompensatedPercentage(e.totalEmissions,e.totalCompensations),"% compensado) ")}}function Re(d,g){if(d&1){let e=E();r(0,"div")(1,"h2",25),a(2,"Emisiones de CO\u2082 por a\xF1o"),n(),r(3,"div",26)(4,"h3",27),a(5),n(),r(6,"div",28)(7,"button",29),C("click",function(){p(e);let i=l(2);return u(i.toggleEditCO2(i.co2Years[0]))}),a(8),n()(),y(9,Te,11,2,"div",30),r(10,"div",31)(11,"div",32)(12,"div",33),a(13,"Emitido"),n(),_(14,"canvas",34),n(),r(15,"div",32)(16,"div",33),a(17,"Compensado"),n(),_(18,"canvas",34),n(),r(19,"div",32)(20,"div",33),a(21,"Valor Neto"),n(),r(22,"div",35),a(23),T(24,"number"),n(),r(25,"div",36),a(26,"Toneladas de CO\u2082"),n(),r(27,"div",37),a(28),n()()()(),y(29,Ae,24,11,"div",38),n()}if(d&2){let e=l(2);s(5),x("\xDAltimo a\xF1o registrado: ",e.co2Years[0].year,""),s(3),x(" ",e.co2Years[0].editMode?"Cancelar":"Editar"," "),s(),c("ngIf",e.co2Years[0].editMode),s(5),c("id",e.co2Years[0].emitidoRef),s(4),c("id",e.co2Years[0].compensadoRef),s(4),c("ngClass",e.getNetColorClass(e.co2Years[0].totalEmissions,e.co2Years[0].totalCompensations)),s(),x(" ",N(24,9,e.co2Years[0].totalEmissions-e.co2Years[0].totalCompensations,"1.0-0")," "),s(5),x(" (Has compensado el ",e.getCompensatedPercentage(e.co2Years[0].totalEmissions,e.co2Years[0].totalCompensations),"%) "),s(),c("ngForOf",e.co2Years.slice(1))}}function ke(d,g){if(d&1&&(r(0,"option",47),a(1),n()),d&2){let e=g.$implicit;c("value",e),s(),B(e)}}function De(d,g){if(d&1){let e=E();r(0,"div",1)(1,"form",2),C("ngSubmit",function(){p(e);let i=l();return u(i.onSubmitCompany())}),r(2,"h1",3),a(3),n(),r(4,"div",4),_(5,"img",5),r(6,"label",6)(7,"span",7),a(8,"photo_camera"),n(),r(9,"span"),a(10,"Seleccionar imagen"),n(),r(11,"input",8),C("change",function(i){p(e);let o=l();return u(o.onCompanyFileSelected(i))}),n()()(),r(12,"div",9)(13,"div",10)(14,"label",11),a(15,"Nombre"),n(),_(16,"input",12),n(),r(17,"div",10)(18,"label",13),a(19,"Direcci\xF3n"),n(),_(20,"input",14),n()(),r(21,"div",15)(22,"button",16),C("click",function(){p(e);let i=l();return u(i.cancel())}),a(23," Cancelar "),n(),r(24,"button",17),a(25," Guardar empresa "),n()()(),_(26,"hr",18),y(27,Re,30,12,"div",19),r(28,"div",20)(29,"label",21),a(30,"A\xF1o"),n(),r(31,"select",22),F("ngModelChange",function(i){p(e);let o=l();return S(o.selectedYear,i)||(o.selectedYear=i),u(i)}),y(32,ke,2,2,"option",23),n(),_(33,"br"),r(34,"button",24),C("click",function(){p(e);let i=l();return u(i.addNewYear(i.selectedYear))}),a(35," A\xF1adir a\xF1o "),n()()()}if(d&2){let e=l();s(),c("formGroup",e.companyForm),s(2),x(" ",e.company.id?"Editar Compa\xF1\xEDa":"Nueva Compa\xF1\xEDa"," "),s(2),c("src",e.previewImage||e.company.picture||"assets/logo-white.png",P),s(22),c("ngIf",e.co2Years==null?null:e.co2Years.length),s(4),w("ngModel",e.selectedYear),s(),c("ngForOf",e.availableYears)}}var et=(()=>{class d{constructor(e,t,i,o,m,h){this.fb=e,this.companyService=t,this.companyCo2Service=i,this.route=o,this.router=m,this.userService=h,this.company={id:void 0,name:"",address:"",co2:[]},this.co2Years=[],this.chartsMap={},this.availableYears=[],this.destroy$=new k,A.register(be,Ee,Se,we)}ngOnInit(){this.initForm();let e=Number(this.route.snapshot.paramMap.get("id"));e&&this.loadCompany(e),this.userService.getUser().pipe(b(this.destroy$)).subscribe(t=>this.user=t)}ngOnDestroy(){Object.values(this.chartsMap).forEach(e=>e.destroy()),this.destroy$.next(),this.destroy$.complete()}initForm(){this.companyForm=this.fb.group({name:["",ne.required],address:[""]})}loadCompany(e){this.companyService.getCompanyById(e).pipe(b(this.destroy$)).subscribe(t=>{this.company=t,this.companyForm.patchValue({name:t.name,address:t.address}),this.previewImage=t.picture,this.prepareCO2Years(),this.updateAvailableYears()})}onCompanyFileSelected(e){let t=e.target.files[0];if(!t)return;this.selectedFile=t;let i=new FileReader;i.onload=()=>this.previewImage=i.result,i.readAsDataURL(t)}onSubmitCompany(){if(this.companyForm.invalid)return;let e=this.companyForm.value,t=[];if(!this.company.id)t.push(this.companyService.createCompany(e).pipe(I(i=>(console.error("Error creando empresa",i),V(null)))));else if(this.selectedFile&&t.push(this.companyService.updateCompanyPicture(this.company.id,this.selectedFile).pipe(I(i=>(console.error("Error actualizando imagen",i),V(this.company))))),(e.name!==this.company.name||e.address!==this.company.address)&&t.push(this.companyService.updateCompany(this.company.id,e).pipe(I(i=>(console.error("Error actualizando empresa",i),V(this.company))))),!t.length)return;D(t).pipe(b(this.destroy$)).subscribe(i=>{let o=i[i.length-1];o&&(this.company=o,this.companyForm.patchValue({name:o.name,address:o.address}),this.previewImage=o.picture,this.selectedFile=void 0,this.prepareCO2Years(),this.updateAvailableYears(),this.user&&(this.user.role==="ADMIN"?this.router.navigate(["/admin/companies"]):this.user.role==="COMPANY_ADMIN"?this.router.navigate(["/company"]):this.router.navigate(["/home"])))})}cancel(){this.user&&(this.user.role==="ADMIN"?this.router.navigate(["/admin/companies"]):this.user.role==="COMPANY_ADMIN"?this.router.navigate(["/company"]):this.router.navigate(["/home"]))}prepareCO2Years(){if(!this.company?.co2?.length){this.co2Years=[];return}let e=[...this.company.co2].filter(t=>t.year!==void 0).sort((t,i)=>i.year-t.year);this.co2Years=e.map(t=>({id:t.id,year:t.year,totalEmissions:t.totalEmissions||0,totalCompensations:t.totalCompensations||0,net:(t.totalEmissions||0)-(t.totalCompensations||0),emitidoRef:`emitido-${t.year}`,compensadoRef:`compensado-${t.year}`,netoRef:`neto-${t.year}`,editMode:!1,editEmissions:t.totalEmissions||0,editCompensations:t.totalCompensations||0})),setTimeout(()=>this.renderCO2Charts(),0)}toggleEditCO2(e){e.editMode?e._backup&&(e.totalEmissions=e._backup.emissions,e.totalCompensations=e._backup.compensations):e._backup={emissions:e.totalEmissions,compensations:e.totalCompensations},e.editMode=!e.editMode,setTimeout(()=>this.renderCO2Charts(),0)}saveCO2(e){if(!this.company?.id)return;let t=e.editEmissions??0,i=e.editCompensations??0;e.net=t-i;let o={year:e.year,totalEmissions:t,totalCompensations:i};this.companyCo2Service.save(this.company.id,o).pipe(b(this.destroy$)).subscribe({next:m=>{e.id=m.id,e.totalEmissions=t,e.totalCompensations=i,e.editMode=!1,this.renderCO2Charts(),this.updateAvailableYears()},error:m=>console.error("Error guardando CO\u2082",m)})}addNewYear(e){if(!e||!this.company?.id)return;let t={year:e,totalEmissions:0,totalCompensations:0,net:0,emitidoRef:`emitido-${e}`,compensadoRef:`compensado-${e}`,netoRef:`neto-${e}`,editMode:!0,editEmissions:0,editCompensations:0},i={year:e,totalEmissions:0,totalCompensations:0};this.companyCo2Service.save(this.company.id,i).pipe(b(this.destroy$)).subscribe({next:o=>{t.id=o.id,this.co2Years.push(t),this.co2Years.sort((m,h)=>h.year-m.year),this.selectedYear=void 0,this.updateAvailableYears(),setTimeout(()=>this.renderCO2Charts(),0)},error:o=>console.error("Error guardando nuevo a\xF1o CO\u2082",o)})}createDonutChart(e,t,i,o){let m=e.getContext("2d");if(!m)return;this.chartsMap[e.id]&&this.chartsMap[e.id].destroy();let h={id:"centerText",beforeDraw:Ve=>{let{ctx:f,width:R,height:Y}=Ve;f&&(f.save(),f.font=`${Y/100*20}px sans-serif`,f.fillStyle="#333",f.textBaseline="middle",f.fillText(`${t}`,R/2-f.measureText(`${t}`).width/2,Y/2-10),f.font=`${Y/100*8}px sans-serif`,f.fillStyle="#666",f.fillText("Toneladas de CO\u2082",R/2-f.measureText("Toneladas de CO\u2082").width/2,Y/2+15),f.restore())}},O=o>0?o:1,M=t/O*100,Me={datasets:[{data:[M,100-M],backgroundColor:[i,"#e0e0e0"],cutout:"75%",borderWidth:0}]},Ye={responsive:!0,animation:{animateRotate:!0,animateScale:!0,duration:1e3},plugins:{legend:{display:!1},tooltip:{enabled:!1}}};this.chartsMap[e.id]=new A(m,{type:"doughnut",data:Me,options:Ye,plugins:[h]})}renderCO2Charts(){Object.values(this.chartsMap).forEach(t=>t.destroy()),this.chartsMap={};let e=["emitidoRef","compensadoRef","netoRef"];this.co2Years.forEach((t,i)=>{let o=i===0?200:80;e.forEach(m=>{let h=document.getElementById(t[m]);if(!h)return;h.width=o,h.height=o;let O=m==="emitidoRef"?t.totalEmissions:m==="compensadoRef"?t.totalCompensations:t.net,M=m==="emitidoRef"?"#fc4d03ff":m==="compensadoRef"?"#89de8cff":"#2c80c5cf";this.createDonutChart(h,O,M,t.totalEmissions||1)})})}updateAvailableYears(){let e=new Date().getFullYear(),t=this.co2Years.map(i=>i.year);this.availableYears=[];for(let i=2020;i<=e;i++)t.includes(i)||this.availableYears.push(i);this.availableYears.sort((i,o)=>o-i)}getNetColorClass(e,t){let i=e-t,o=e>0?i/e:1;return o<.5?"net-yellow":o<=1?"net-red":"net-green"}getCompensatedPercentage(e,t){return e?(t/e*100).toFixed(0):"0"}static{this.\u0275fac=function(t){return new(t||d)(v(he),v(ye),v(Fe),v(J),v(K),v(X))}}static{this.\u0275cmp=$({type:d,selectors:[["app-company-form"]],standalone:!0,features:[L],decls:1,vars:1,consts:[["class","mt-5 p-6 rounded-2xl shadow-md bg-white max-w-3xl mx-auto",4,"ngIf"],[1,"mt-5","p-6","rounded-2xl","shadow-md","bg-white","max-w-3xl","mx-auto"],[3,"ngSubmit","formGroup"],[1,"text-2xl","font-bold","mb-6","text-center"],[1,"md:col-span-2","flex","flex-col","items-center","mb-6"],["alt","Logo de la compa\xF1\xEDa",1,"w-24","h-24","rounded-full","shadow-lg","mb-2","object-cover",3,"src"],[1,"cursor-pointer","bg-gray-200","hover:bg-gray-300","p-2","rounded-full","flex","items-center","gap-2"],[1,"material-icons"],["type","file","accept","image/*","hidden","",3,"change"],[1,"flex","flex-col","md:flex-row","gap-4","mb-6"],[1,"flex-1"],["for","name",1,"block","text-gray-700","font-medium","mb-1"],["id","name","type","text","formControlName","name","required","","placeholder","Nombre de la compa\xF1\xEDa",1,"w-full","rounded-xl","border","border-gray-300","px-4","py-2","shadow-sm","focus:outline-none","focus:ring-2","focus:ring-blue-500","focus:border-transparent","transition"],["for","address",1,"block","text-gray-700","font-medium","mb-1"],["id","address","type","text","formControlName","address","placeholder","Direcci\xF3n",1,"w-full","rounded-xl","border","border-gray-300","px-4","py-2","shadow-sm","focus:outline-none","focus:ring-2","focus:ring-blue-500","focus:border-transparent","transition"],[1,"flex","justify-end","gap-4","mt-4"],["type","button",1,"px-4","py-2","rounded-xl","border","border-red-500","text-red-500","hover:bg-red-50","transition",3,"click"],["type","submit",1,"px-4","py-2","rounded-xl","bg-blue-600","text-white","hover:bg-blue-700","transition"],[1,"my-6"],[4,"ngIf"],[1,"border","p-4","rounded-xl","shadow-sm","text-center","mt-6","bg-gray-50"],["for","newYear",1,"block","text-gray-700","font-medium","mb-2"],["id","newYear","name","newYear",1,"w-32","rounded-xl","border","border-gray-300","px-3","py-2","shadow-sm","focus:outline-none","focus:ring-2","focus:ring-blue-500","focus:border-transparent","transition","mb-2",3,"ngModelChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],[1,"px-4","py-2","rounded-xl","bg-blue-600","text-white","hover:bg-blue-700","transition",3,"click"],[1,"text-xl","font-bold","mb-4","text-center"],[1,"mb-8","border","p-4","rounded-xl","shadow-sm","bg-gray-50"],[1,"font-semibold","mb-2"],[1,"flex","justify-end","mb-2"],[1,"px-3","py-1","rounded-xl","border","border-blue-500","text-blue-500","hover:bg-blue-50","transition",3,"click"],["class","flex flex-wrap gap-4 mb-4 justify-center",4,"ngIf"],[1,"flex","flex-wrap","gap-4","justify-center","items-center"],[1,"text-center"],[1,"font-medium"],[1,"donut-large",3,"id"],[1,"text-4xl","font-bold",3,"ngClass"],[1,"text-gray-600","text-sm"],[1,"text-xs","text-gray-500","mt-1"],["class","mb-6 border p-4 rounded-xl shadow-sm bg-gray-50",4,"ngFor","ngForOf"],[1,"flex","flex-wrap","gap-4","mb-4","justify-center"],[1,"block","text-gray-700","font-medium","mb-1"],["type","number",1,"w-32","rounded-xl","border","border-gray-300","px-3","py-1","shadow-sm","focus:outline-none","focus:ring-2","focus:ring-blue-500","focus:border-transparent","transition",3,"ngModelChange","ngModel"],[1,"mb-6","border","p-4","rounded-xl","shadow-sm","bg-gray-50"],[1,"donut-small",3,"id"],[1,"font-semibold","text-lg",3,"ngClass"],[1,"text-sm","text-gray-600"],[1,"text-xs","text-gray-500"],[3,"value"]],template:function(t,i){t&1&&y(0,De,36,6,"div",0),t&2&&c("ngIf",i.company)},dependencies:[H,G,U,q,z,_e,se,pe,ue,ie,de,ce,oe,re,fe,ae,xe,le,me,Z,ee,Ce,ge,ve,te],encapsulation:2})}}return d})();export{et as CompanyFormComponent};
