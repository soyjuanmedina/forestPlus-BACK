import{B as g,E as p,H as l,Jb as m,i as a,k as h,l as c,m as s,n,s as o,xc as d,z as f}from"./chunk-P2JR76SF.js";var v=(()=>{class i{constructor(r,e){this.authApi=r,this.router=e,this.userSubject=new a(null),this.user$=this.userSubject.asObservable(),this.tokenSubject=new a(localStorage.getItem("forestPlus_token")),this.token$=this.tokenSubject.asObservable();let t=localStorage.getItem("forestPlus_user");t&&this.userSubject.next(JSON.parse(t))}isLoggedIn(){return this.userSubject.value!==null}logout(){localStorage.removeItem("forestPlus_token"),localStorage.removeItem("forestPlus_user"),this.userSubject.next(null),this.router.navigate(["/login"])}getUser(){return this.userSubject.value}setUser(r,e){let t;r instanceof Blob?r.text().then(u=>{try{t=JSON.parse(u),this.applyUser(t,e)}catch(S){console.error("\u274C Error al parsear usuario desde Blob:",S)}}):(t=r,this.applyUser(t,e))}applyUser(r,e){this.userSubject.next(r),localStorage.setItem("forestPlus_user",JSON.stringify(r)),e&&(localStorage.setItem("forestPlus_token",e),this.tokenSubject.next(e))}login(r){return this.authApi.login(r).pipe(f(e=>{if(!e.user)throw new Error("No se recibi\xF3 el usuario en la respuesta del login");return e.user instanceof Blob?h(e.user.text()).pipe(n(t=>JSON.parse(t)),g(t=>this.setUser(t,e.token))):(this.setUser(e.user,e.token),c(e.user))}),o(e=>(console.error("Error login",e),s(()=>e))))}register(r){return this.authApi.register(r).pipe(n(e=>{let t=e;if(!t)throw new Error("No se recibi\xF3 el usuario tras el registro");return this.setUser(t),t}),o(e=>s(()=>e)))}forgotPassword(r){return this.authApi.forgotPassword({email:r}).pipe(o(e=>s(()=>e)))}resetPassword(r,e){if(e)return this.authApi.resetForgotPassword(e,r);let t=localStorage.getItem("forestPlus_token");if(!t)throw new Error("No hay token de usuario logueado");let u=`Bearer ${t}`;return this.authApi.resetPassword(u,r)}verifyEmail(r){return this.authApi.verifyEmail(r).pipe(o(e=>s(()=>e)))}updateCurrentUser(r){let e=localStorage.getItem("forestPlus_token");this.setUser(r,e??void 0)}resendVerification(r){return this.authApi.resendVerification({email:r})}resetForgotPassword(r,e){return this.authApi.resetForgotPassword(r,e)}refreshToken(){let r=localStorage.getItem("forestPlus_refresh_token");return r?this.authApi.refreshToken({refreshToken:r}).pipe(n(e=>{if(!e.user||!e.token)throw new Error("Refresh failed: no token/user received");return this.setUser(e.user,e.token),e.refreshToken&&localStorage.setItem("forestPlus_refresh_token",e.refreshToken),e}),o(e=>(this.logout(),s(()=>e)))):(this.logout(),s(()=>new Error("No refresh token found")))}get currentUserRole(){return this.userSubject.value?.role??null}get currentUserCompanyId(){return this.userSubject.value?.company?.id??null}static{this.\u0275fac=function(e){return new(e||i)(l(d),l(m))}}static{this.\u0275prov=p({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();export{v as a};
