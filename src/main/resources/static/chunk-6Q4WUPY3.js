import{a as Z,b as ee,c as ce,d as pe,e as ue,f as fe,g as Ce,h as _e,i as he,j as ve,k as A,l as ye,m as xe,n as be}from"./chunk-STGUSWTR.js";import{$ as P,$a as L,Ad as ge,Bb as K,Ca as M,Cc as re,D as W,Fa as C,Fc as se,G as N,Ha as c,Hc as me,K as B,Nc as de,Pc as le,Q as u,R as f,Sa as r,Ta as j,Ua as _,Xa as g,Ya as v,Za as y,a as I,aa as m,ba as E,bb as O,db as V,ic as H,j as T,ja as w,mb as U,na as l,nb as z,ob as q,pc as Q,q as k,rb as G,sb as $,sc as X,t as D,tc as te,wa as o,wc as ie,xa as n,xc as ne,ya as x,yc as oe,zb as J,zc as ae}from"./chunk-QLNJI7UZ.js";var Ee=(()=>{class d{constructor(e){this.co2Api=e}getAll(e){return this.co2Api.getAll(e)}save(e,t){return this.co2Api.createOrUpdate(e,t)}delete(e,t){return this.co2Api._delete(e,t)}static{this.\u0275fac=function(t){return new(t||d)(N(Q))}}static{this.\u0275prov=W({token:d,factory:d.\u0275fac,providedIn:"root"})}}return d})();function Ie(d,b){if(d&1){let e=M();o(0,"div",34)(1,"mat-form-field",16)(2,"mat-label"),r(3,"Emitido"),n(),o(4,"input",35),y("ngModelChange",function(i){u(e);let a=c(2);return v(a.co2Years[0].editEmissions,i)||(a.co2Years[0].editEmissions=i),f(i)}),n()(),o(5,"mat-form-field",16)(6,"mat-label"),r(7,"Compensado"),n(),o(8,"input",35),y("ngModelChange",function(i){u(e);let a=c(2);return v(a.co2Years[0].editCompensations,i)||(a.co2Years[0].editCompensations=i),f(i)}),n()(),o(9,"button",12),C("click",function(){u(e);let i=c(2);return f(i.saveCO2(i.co2Years[0]))}),r(10,"Guardar"),n()()}if(d&2){let e=c(2);m(4),g("ngModel",e.co2Years[0].editEmissions),m(4),g("ngModel",e.co2Years[0].editCompensations)}}function Te(d,b){if(d&1){let e=M();o(0,"div",34)(1,"mat-form-field",16)(2,"mat-label"),r(3,"Emitido"),n(),o(4,"input",35),y("ngModelChange",function(i){u(e);let a=c().$implicit;return v(a.editEmissions,i)||(a.editEmissions=i),f(i)}),n()(),o(5,"mat-form-field",16)(6,"mat-label"),r(7,"Compensado"),n(),o(8,"input",35),y("ngModelChange",function(i){u(e);let a=c().$implicit;return v(a.editCompensations,i)||(a.editCompensations=i),f(i)}),n()(),o(9,"button",12),C("click",function(){u(e);let i=c().$implicit,a=c(2);return f(a.saveCO2(i))}),r(10,"Guardar"),n()()}if(d&2){let e=c().$implicit;m(4),g("ngModel",e.editEmissions),m(4),g("ngModel",e.editCompensations)}}function De(d,b){if(d&1){let e=M();o(0,"div",36)(1,"h3",21),r(2),n(),o(3,"div",22)(4,"button",23),C("click",function(){let i=u(e).$implicit,a=c(2);return f(a.toggleEditCO2(i))}),r(5),n()(),w(6,Te,11,2,"div",24),o(7,"div",25)(8,"div",26),x(9,"canvas",37),n(),o(10,"div",26),x(11,"canvas",37),n(),o(12,"div",29)(13,"div",38),r(14),O(15,"number"),n(),o(16,"div",31),r(17,"Toneladas de CO\u2082"),n(),o(18,"div",32),r(19),n()()()()}if(d&2){let e=b.$implicit,t=c(2);m(2),_("A\xF1o ",e.year,""),m(3),_(" ",e.editMode?"Cancelar":"Editar"," "),m(),l("ngIf",e.editMode),m(3),l("id",e.emitidoRef),m(2),l("id",e.compensadoRef),m(2),l("ngClass",t.getNetColorClass(e.totalEmissions,e.totalCompensations)),m(),_(" ",V(15,8,e.totalEmissions-e.totalCompensations,"1.0-0")," "),m(5),_(" (has compensado el ",t.getCompensatedPercentage(e.totalEmissions,e.totalCompensations),"% de tus emisiones) ")}}function Oe(d,b){if(d&1){let e=M();o(0,"div")(1,"h2",19),r(2,"Emisiones de CO\u2082 por a\xF1o"),n(),o(3,"div",20)(4,"h3",21),r(5),n(),o(6,"div",22)(7,"button",23),C("click",function(){u(e);let i=c();return f(i.toggleEditCO2(i.co2Years[0]))}),r(8),n()(),w(9,Ie,11,2,"div",24),o(10,"div",25)(11,"div",26)(12,"div",27),r(13,"Emitido"),n(),x(14,"canvas",28),n(),o(15,"div",26)(16,"div",27),r(17,"Compensado"),n(),x(18,"canvas",28),n(),o(19,"div",29)(20,"div",27),r(21,"Valor Neto"),n(),o(22,"div",30),r(23),O(24,"number"),n(),o(25,"div",31),r(26,"Toneladas de CO\u2082"),n(),o(27,"div",32),r(28),n()()()(),w(29,De,20,11,"div",33),n()}if(d&2){let e=c();m(5),_("\xDAltimo a\xF1o registrado: ",e.co2Years[0].year,""),m(3),_(" ",e.co2Years[0].editMode?"Cancelar":"Editar"," "),m(),l("ngIf",e.co2Years[0].editMode),m(5),l("id",e.co2Years[0].emitidoRef),m(4),l("id",e.co2Years[0].compensadoRef),m(4),l("ngClass",e.getNetColorClass(e.co2Years[0].totalEmissions,e.co2Years[0].totalCompensations)),m(),_(" ",V(24,9,e.co2Years[0].totalEmissions-e.co2Years[0].totalCompensations,"1.0-0")," "),m(5),_(" (has compensado el ",e.getCompensatedPercentage(e.co2Years[0].totalEmissions,e.co2Years[0].totalCompensations),"% de tus emisiones) "),m(),l("ngForOf",e.co2Years.slice(1))}}function Ve(d,b){if(d&1&&(o(0,"mat-option",39),r(1),n()),d&2){let e=b.$implicit;l("value",e),m(),j(e)}}var nt=(()=>{class d{constructor(e,t,i,a,s){this.companyService=e,this.companyCo2Service=t,this.route=i,this.router=a,this.userService=s,this.editData={},this.co2Years=[],this.chartsMap={},this.availableYears=[],A.register(ve,ye,be,xe)}ngOnInit(){let e=Number(this.route.snapshot.paramMap.get("id"));e&&(this.userService.getUser().subscribe(t=>this.user=t),this.companyService.getCompanyById(e).subscribe(t=>{this.company=t,this.editData=I({},t),this.prepareCO2Years(),this.updateAvailableYears()}))}onCompanyFileSelected(e){let t=e.target.files[0];if(!t)return;this.selectedFile=t;let i=new FileReader;i.onload=()=>this.previewImage=i.result,i.readAsDataURL(t)}saveCompany(){if(!this.company?.id)return;let e=[];this.selectedFile&&e.push(this.companyService.updateCompanyPicture(this.company.id,this.selectedFile).pipe(D(t=>(console.error("Error actualizando imagen",t),T(this.company))))),(this.editData.name!==this.company.name||this.editData.address!==this.company.address)&&e.push(this.companyService.updateCompany(this.company.id,{name:this.editData.name,address:this.editData.address}).pipe(D(t=>(console.error("Error actualizando empresa",t),T(this.company))))),e.length&&k(e).subscribe(t=>{let i=t[t.length-1];this.company=i,this.editData=I({},i),this.selectedFile=void 0,this.previewImage=void 0,this.prepareCO2Years(),this.updateAvailableYears()})}cancel(){this.user&&(this.user.role==="ADMIN"?this.router.navigate(["/admin/companies"]):this.user.role==="COMPANY_ADMIN"?this.router.navigate(["/company"]):this.router.navigate(["/home"]))}prepareCO2Years(){if(!this.company?.co2?.length)return;let e=[...this.company.co2].filter(t=>t.year!==void 0).sort((t,i)=>i.year-t.year);this.co2Years=e.map(t=>({id:t.id,year:t.year,totalEmissions:t.totalEmissions||0,totalCompensations:t.totalCompensations||0,net:(t.totalEmissions||0)-(t.totalCompensations||0),emitidoRef:`emitido-${t.year}`,compensadoRef:`compensado-${t.year}`,netoRef:`neto-${t.year}`,editMode:!1,editEmissions:t.totalEmissions||0,editCompensations:t.totalCompensations||0})),setTimeout(()=>this.renderCO2Charts(),0)}toggleEditCO2(e){e.editMode?e._backup&&(e.totalEmissions=e._backup.emissions,e.totalCompensations=e._backup.compensations):e._backup={emissions:e.totalEmissions,compensations:e.totalCompensations},e.editMode=!e.editMode,setTimeout(()=>this.renderCO2Charts(),0)}saveCO2(e){if(!this.company?.id)return;let t=e.editEmissions??0,i=e.editCompensations??0;e.net=t-i;let a={year:e.year,totalEmissions:t,totalCompensations:i};this.companyCo2Service.save(this.company.id,a).subscribe({next:s=>{e.id=s.id,e.totalEmissions=t,e.totalCompensations=i,e.editMode=!1,this.renderCO2Charts(),this.updateAvailableYears()},error:s=>console.error("Error guardando CO\u2082",s)})}addNewYear(e){if(!e||!this.company?.id)return;let t={year:e,totalEmissions:0,totalCompensations:0,net:0,emitidoRef:`emitido-${e}`,compensadoRef:`compensado-${e}`,netoRef:`neto-${e}`,editMode:!0,editEmissions:0,editCompensations:0},i={year:e,totalEmissions:0,totalCompensations:0};this.companyCo2Service.save(this.company.id,i).subscribe({next:a=>{t.id=a.id,this.co2Years.push(t),this.co2Years.sort((s,h)=>h.year-s.year),this.selectedYear=void 0,this.updateAvailableYears(),setTimeout(()=>this.renderCO2Charts(),0)},error:a=>console.error("Error guardando nuevo a\xF1o CO\u2082",a)})}createDonutChart(e,t,i,a){let s=e.getContext("2d");if(!s)return;this.chartsMap[e.id]&&this.chartsMap[e.id].destroy();let h={id:"centerText",beforeDraw:Se=>{let{ctx:p,width:R,height:F}=Se;p&&(p.save(),p.font=`${F/100*20}px sans-serif`,p.fillStyle="#333",p.textBaseline="middle",p.fillText(`${t}`,R/2-p.measureText(`${t}`).width/2,F/2-10),p.font=`${F/100*8}px sans-serif`,p.fillStyle="#666",p.fillText("Toneladas de CO\u2082",R/2-p.measureText("Toneladas de CO\u2082").width/2,F/2+15),p.restore())}},Y=a>0?a:1,S=t/Y*100,we={datasets:[{data:[S,100-S],backgroundColor:[i,"#e0e0e0"],cutout:"75%",borderWidth:0}]},Me={responsive:!0,animation:{animateRotate:!0,animateScale:!0,duration:1e3},plugins:{legend:{display:!1},tooltip:{enabled:!1}}};this.chartsMap[e.id]=new A(s,{type:"doughnut",data:we,options:Me,plugins:[h]})}renderCO2Charts(){let e=["emitidoRef","compensadoRef","netoRef"];this.co2Years.forEach((t,i)=>{let a=i===0?200:80;e.forEach(s=>{let h=document.getElementById(t[s]);if(!h)return;h.width=a,h.height=a;let Y=s==="emitidoRef"?t.totalEmissions:s==="compensadoRef"?t.totalCompensations:t.net,S=s==="emitidoRef"?"#fc4d03ff":s==="compensadoRef"?"#89de8cff":"#2c80c5cf";this.createDonutChart(h,Y,S,t.totalEmissions||1)})})}updateAvailableYears(){let e=new Date().getFullYear(),t=this.co2Years.map(i=>i.year);this.availableYears=[];for(let i=2020;i<=e;i++)t.includes(i)||this.availableYears.push(i);this.availableYears.sort((i,a)=>a-i)}getNetColorClass(e,t){let i=e-t,a=e>0?i/e:1;return a<.5?"net-yellow":a<=1?"net-red":"net-green"}getCompensatedPercentage(e,t){return e?(t/e*100).toFixed(0):"0"}static{this.\u0275fac=function(t){return new(t||d)(E(ge),E(Ee),E(J),E(K),E(X))}}static{this.\u0275cmp=B({type:d,selectors:[["app-company-form"]],standalone:!0,features:[L],decls:35,vars:6,consts:[[1,"p-6","rounded-2xl","shadow-md","bg-white","max-w-3xl","mx-auto"],[1,"text-2xl","font-bold","mb-6","text-center"],[1,"md:col-span-2","flex","flex-col","items-center","mb-6"],["alt","Logo de la compa\xF1\xEDa",1,"w-24","h-24","rounded-full","shadow-lg","mb-2",3,"src"],[1,"cursor-pointer","bg-gray-200","hover:bg-gray-300","p-2","rounded-full","flex","items-center","gap-2"],["type","file","accept","image/*","hidden","",3,"change"],[1,"flex","flex-col","md:flex-row","gap-4","mb-6"],["appearance","outline",1,"flex-1"],["matInput","","name","name","required","",3,"ngModelChange","ngModel"],["matInput","","name","address",3,"ngModelChange","ngModel"],[1,"flex","justify-end","gap-4","mt-4"],["mat-stroked-button","","color","warn",3,"click"],["mat-raised-button","","color","primary",3,"click"],[1,"my-6"],[4,"ngIf"],[1,"border","p-4","rounded","shadow-sm","text-center"],["appearance","outline"],["name","newYear",3,"ngModelChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],[1,"text-xl","font-bold","mb-4","text-center"],[1,"mb-8","border","p-4","rounded","shadow-sm"],[1,"font-semibold","mb-2"],[1,"flex","justify-end","mb-2"],["mat-stroked-button","","color","primary",3,"click"],["class","flex gap-4 mb-2 justify-center",4,"ngIf"],[1,"flex","gap-4","justify-center","mb-2","items-center"],[1,"donut-wrapper","text-center"],[1,"donut-label"],[1,"donut-large",3,"id"],[1,"donut-wrapper","neto-wrapper","text-center"],[1,"donut-neto","text-4xl","font-bold",3,"ngClass"],[1,"donut-neto-unit"],[1,"donut-neto-info"],["class","mb-6 border p-4 rounded shadow-sm",4,"ngFor","ngForOf"],[1,"flex","gap-4","mb-2","justify-center"],["matInput","","type","number",3,"ngModelChange","ngModel"],[1,"mb-6","border","p-4","rounded","shadow-sm"],[1,"donut-small",3,"id"],[1,"donut-neto","text-xl","font-bold",3,"ngClass"],[3,"value"]],template:function(t,i){t&1&&(o(0,"mat-card",0)(1,"h1",1),r(2,"Editar Compa\xF1\xEDa"),n(),o(3,"div",2),x(4,"img",3),o(5,"label",4)(6,"mat-icon"),r(7,"photo_camera"),n(),o(8,"span"),r(9,"Seleccionar imagen"),n(),o(10,"input",5),C("change",function(s){return i.onCompanyFileSelected(s)}),n()()(),o(11,"div",6)(12,"mat-form-field",7)(13,"mat-label"),r(14,"Nombre"),n(),o(15,"input",8),y("ngModelChange",function(s){return v(i.editData.name,s)||(i.editData.name=s),s}),n()(),o(16,"mat-form-field",7)(17,"mat-label"),r(18,"Direcci\xF3n"),n(),o(19,"input",9),y("ngModelChange",function(s){return v(i.editData.address,s)||(i.editData.address=s),s}),n()()(),o(20,"div",10)(21,"button",11),C("click",function(){return i.cancel()}),r(22,"Cancelar"),n(),o(23,"button",12),C("click",function(){return i.saveCompany()}),r(24,"Guardar empresa"),n()(),x(25,"hr",13),w(26,Oe,30,12,"div",14),o(27,"div",15)(28,"mat-form-field",16)(29,"mat-label"),r(30,"A\xF1o"),n(),o(31,"mat-select",17),y("ngModelChange",function(s){return v(i.selectedYear,s)||(i.selectedYear=s),s}),w(32,Ve,2,2,"mat-option",18),n()(),o(33,"button",12),C("click",function(){return i.addNewYear(i.selectedYear)}),r(34,"A\xF1adir a\xF1o"),n()()()),t&2&&(m(4),l("src",i.previewImage||i.editData.picture||"assets/logo-white.png",P),m(11),g("ngModel",i.editData.name),m(4),g("ngModel",i.editData.address),m(7),l("ngIf",i.co2Years==null?null:i.co2Years.length),m(5),g("ngModel",i.selectedYear),m(),l("ngForOf",i.availableYears))},dependencies:[$,U,z,q,G,le,ae,me,re,de,se,ee,Z,ie,te,ue,pe,ce,Ce,fe,he,_e,H,oe,ne],encapsulation:2})}}return d})();export{nt as CompanyFormComponent};
