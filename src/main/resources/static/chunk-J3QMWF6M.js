import{a as se,b as le}from"./chunk-SHJH5Y42.js";import{d as ae}from"./chunk-HULGEKQ2.js";import{a as h,b as T,c as q}from"./chunk-E3OZWIU4.js";import"./chunk-XS7UVQ2S.js";import{c as re}from"./chunk-V3ZUTP7L.js";import{a as G}from"./chunk-EXF7HJ4G.js";import"./chunk-KJOA3MG3.js";import{a as $}from"./chunk-2NTTT4Z7.js";import{a as oe}from"./chunk-XW34JPAT.js";import"./chunk-MFMAHMNS.js";import"./chunk-I6AMTEEF.js";import{b as Q}from"./chunk-ZHCHUJD6.js";import"./chunk-HFKDLU6P.js";import{b as z,d as S,f as H,g as W,j as J,l as K,m as X,n as Z,o as ee,p as te,s as ie,u as ne}from"./chunk-KRWOFNNG.js";import{$ as N,$a as B,Ba as F,Ea as U,Ga as v,Gb as V,Ib as k,J as w,O as b,P as y,Qa as M,Qb as Y,Ra as s,Rb as j,Sa as c,Ta as _,aa as r,ba as E,eb as l,fb as d,hb as L,la as g,pa as p,sb as D,tb as O,va as a,wa as o,xa as C,yb as P}from"./chunk-46BDENMO.js";function de(t,m){t&1&&(a(0,"div",31),s(1),l(2,"translate"),o()),t&2&&(r(),c(d(2,1,"USER.FIELD_REQUIRED")))}function pe(t,m){t&1&&(a(0,"div",31),s(1),l(2,"translate"),o()),t&2&&(r(),c(d(2,1,"USER.FIELD_REQUIRED")))}function me(t,m){t&1&&(a(0,"div"),s(1),l(2,"translate"),o()),t&2&&(r(),c(d(2,1,"USER.FIELD_REQUIRED")))}function ce(t,m){t&1&&(a(0,"div"),s(1),l(2,"translate"),o()),t&2&&(r(),_("",d(2,1,"USER.INVALID_EMAIL")," "))}function ue(t,m){if(t&1&&(a(0,"div",31),g(1,me,3,3,"div",19)(2,ce,3,3,"div",19),o()),t&2){let e,n,i=v();r(),p("ngIf",(e=i.userForm.get("email"))==null?null:e.hasError("required")),r(),p("ngIf",(n=i.userForm.get("email"))==null?null:n.hasError("email"))}}function fe(t,m){if(t&1&&(a(0,"option",32),s(1),o()),t&2){let e=m.$implicit;p("value",e.value),r(),c(e.label)}}function ge(t,m){t&1&&(a(0,"div",31),s(1),l(2,"translate"),o()),t&2&&(r(),c(d(2,1,"USER.FIELD_REQUIRED")))}function he(t,m){if(t&1&&(a(0,"option",32),s(1),o()),t&2){let e=m.$implicit;p("value",e.id),r(),c(e.name)}}function _e(t,m){t&1&&(a(0,"div",31),s(1),l(2,"translate"),o()),t&2&&(r(),c(d(2,1,"USER.FIELD_REQUIRED")))}function Ee(t,m){if(t&1&&(a(0,"div")(1,"label",10),s(2),l(3,"translate"),o(),a(4,"select",33)(5,"option",17),s(6),l(7,"translate"),o(),g(8,he,2,2,"option",18),o(),g(9,_e,3,3,"div",12),o()),t&2){let e,n=v();r(2),c(d(3,4,"USER.COMPANY_LABEL")),r(4),c(d(7,6,"USER.SELECT_COMPANY")),r(2),p("ngForOf",n.getSelectableCompanies()),r(),p("ngIf",((e=n.userForm.get("companyId"))==null?null:e.invalid)&&((e=n.userForm.get("companyId"))==null?null:e.touched))}}function ve(t,m){if(t&1&&(a(0,"span",34),s(1),o()),t&2){let e=v();r(),_(" Pendientes de asignar: ",e.user==null?null:e.user.pendingTreesCount," ")}}function xe(t,m){if(t&1){let e=F();a(0,"button",35),U("click",function(){b(e);let i=v();return y(i.openAssignTreesModal(i.user.id))}),s(1),l(2,"translate"),o()}t&2&&(r(),_(" ",d(2,1,"ASSIGN_TREES.ASSIGN_PLANTED_TREES")," "))}function Se(t,m){if(t&1){let e=F();a(0,"button",41),U("click",function(){b(e);let i=v().$implicit,u=v(2);return y(u.openUnassignTreesModal(i))}),s(1),l(2,"translate"),o()}t&2&&(r(),_(" ",d(2,1,"ASSIGN_TREES.UNASSIGN")," "))}function Ie(t,m){if(t&1&&(a(0,"li",37)(1,"div")(2,"span",38),s(3),o(),a(4,"span",39),s(5),o()(),g(6,Se,3,3,"button",40),o()),t&2){let e=m.$implicit,n=v(2);r(3),c(e.treeTypeName),r(2),_("",e.quantity||1," \xE1rboles"),r(),p("ngIf",n.isAdmin)}}function be(t,m){if(t&1&&(a(0,"ul"),g(1,Ie,7,3,"li",36),o()),t&2){let e=v();r(),p("ngForOf",e.plantedTrees)}}function ye(t,m){t&1&&(a(0,"p",42),s(1),l(2,"translate"),o()),t&2&&(r(),c(d(2,1,"LANDS.NO_PLANTED_TREES_BY_USER")))}function Ce(t,m){t&1&&(a(0,"div",43),s(1),l(2,"translate"),o()),t&2&&(r(),_(" ",d(2,1,"USER.SUCCESS_MSG")," "))}function Ue(t,m){if(t&1&&(a(0,"div",44),s(1),o()),t&2){let e=v();r(),_(" ",e.registerError," ")}}var Qe=(()=>{class t{constructor(e,n,i,u,f,x,I,A,R){this.fb=e,this.userService=n,this.authService=i,this.companyService=u,this.router=f,this.snackBar=x,this.route=I,this.dialog=A,this.treeService=R,this.hidePassword=!0,this.roles=T,this.companies=[],this.registerSuccess=!1,this.registerError="",this.isEditMode=!1,this.isSelfEdit=!1,this.RolesEnum=h,this.isCompanyAdmin=!1,this.isAdmin=!1,this.showCompanySelector=!1,this.plantedTrees=[]}ngOnInit(){if(this.currentUser=this.authService.getUser()??void 0,this.isCompanyAdmin=this.currentUser?.role===h.COMPANY_ADMIN,this.isAdmin=this.currentUser?.role===h.ADMIN,this.showCompanySelector=!1,this.userForm=this.fb.group({name:["",S.required],surname:["",S.required],secondSurname:[""],email:["",[S.required,S.email]],password:["",[S.minLength(6)]],role:[null,S.required],companyId:[""]}),this.configureAvailableRoles(),this.isAdmin||this.isCompanyAdmin)this.route.paramMap.subscribe(e=>{let n=e.get("id");n&&(this.isEditMode=!0,this.userId=+n,this.loadUser(this.userId),this.loadUserTrees(this.userId))}),this.isCompanyAdmin?(this.showCompanySelector=!0,this.companyService.getAllCompanies().subscribe({next:e=>{this.companies=e.filter(i=>i.users?.some(u=>u.role===h.COMPANY_ADMIN));let n=this.currentUser?.company?.id;n&&this.userForm.patchValue({companyId:n})},error:e=>console.error("Error cargando compa\xF1\xEDas",e)})):this.loadCompanies();else{this.isEditMode=!0,this.userId=this.currentUser?.id??0;let e=this.userService.getCurrentUser();e&&(this.userForm.patchValue({name:e.name,surname:e.surname,secondSurname:e.secondSurname,email:e.email,role:e.role,companyId:e.company?.id??"",password:""}),this.isSelfEdit=!0,this.userForm.get("role")?.disable(),this.userForm.get("companyId")?.disable(),this.userForm.get("password")?.disable(),this.loadUserTrees(this.userId))}this.userForm.get("role")?.valueChanges.subscribe(e=>{let n=this.userForm.get("companyId");e===h.COMPANY_ADMIN||e===h.COMPANY_USER?(this.showCompanySelector=!0,n?.setValidators([S.required]),n?.enable()):(this.showCompanySelector=!1,n?.clearValidators(),n?.setValue(""),this.isCompanyAdmin||n?.disable()),n?.updateValueAndValidity()})}configureAvailableRoles(){this.currentUser&&(this.currentUser.role===h.ADMIN?this.roles=T:this.currentUser.role===h.COMPANY_ADMIN&&(this.roles=T.filter(e=>e.value===h.COMPANY_ADMIN||e.value===h.COMPANY_USER)))}loadCompanies(){this.companyService.getAllCompanies().subscribe({next:e=>{this.companies=e},error:e=>console.error("Error cargando compa\xF1\xEDas",e)})}loadUser(e){this.userService.getUserById(e).subscribe({next:n=>{this.user=n,this.previewImage=n.picture,this.isSelfEdit=this.currentUser?.id===this.userId,this.userForm.patchValue({name:n.name,surname:n.surname,secondSurname:n.secondSurname,email:n.email,role:n.role,companyId:n.company?.id??""}),this.isSelfEdit?(this.userForm.get("role")?.disable(),this.userForm.get("companyId")?.disable(),this.userForm.get("password")?.disable()):this.userForm.get("email")?.disable()},error:n=>console.error("\u274C Error al cargar usuario",n)})}onFileSelected(e){let n=e.target.files[0];if(n){this.selectedFile=n;let i=new FileReader;i.onload=()=>this.previewImage=i.result,i.readAsDataURL(n)}}onSubmit(){if(this.userForm.invalid)return;let e=this.userForm.getRawValue();this.isCompanyAdmin&&(e.companyId=this.currentUser?.company?.id??void 0);let n;this.selectedFile&&this.isEditMode?n=this.userService.updateUserPicture(this.userId,this.selectedFile):this.isEditMode?n=this.isSelfEdit?this.userService.updateUser(this.userId,e):this.userService.updateUserByAdmin(this.userId,e):n=this.userService.registerUserByAdmin(e),n.subscribe({next:i=>{this.finalizeUpdate(i)},error:i=>{this.registerError=i.error?.message||"Error al guardar usuario",this.registerSuccess=!1,console.error(i)}})}loadUserTrees(e){this.treeService.getTreesByOwner(e).subscribe({next:n=>this.plantedTrees=n,error:n=>console.error("Error al cargar \xE1rboles",n)})}checkRole(){let e=this.authService.currentUserRole;this.isAdmin=e==="ADMIN"}openAssignTreesModal(e){this.dialog.open(se,{width:"400px",data:{userId:e}}).afterClosed().subscribe(i=>{if(i&&i.treeTypeId&&i.plannedPlantationId){let u={ownerUserId:i.ownerUserId,ownerCompanyId:i.ownerCompanyId,landId:i.landId,plannedPlantationId:i.plannedPlantationId,treeTypeId:i.treeTypeId,quantity:i.quantity};this.treeService.plantTreeBatch(u).subscribe({next:()=>{this.userService.getUserById(e).subscribe({next:f=>{this.user=f,this.userForm.patchValue({pendingTreesCount:f.pendingTreesCount}),this.loadUserTrees(e)},error:f=>console.error("Error recargando usuario",f)})},error:f=>{console.error("Error plantando \xE1rboles",f)}})}})}finalizeUpdate(e){this.user=e,this.previewImage=e.picture,this.selectedFile=void 0,this.snackBar.open("\u2705 Usuario actualizado con \xE9xito","Cerrar",{duration:3e3}),this.isSelfEdit?(this.authService.updateCurrentUser(e),this.router.navigate(["/profile"])):this.router.navigate(["/admin/users"])}onCancel(){this.isSelfEdit?this.router.navigate(["/profile"]):this.router.navigate(["/admin/users"])}showCompanySelectorDynamic(){let e=this.userForm.get("role")?.value;return e===h.COMPANY_ADMIN||e===h.COMPANY_USER}isCompanyAdminEditing(){return this.authService.currentUserRole===h.COMPANY_ADMIN}getSelectableCompanies(){return this.authService.currentUserRole===h.ADMIN?this.companies:this.companies.filter(e=>e.id===this.authService.currentUserCompanyId)}openUnassignTreesModal(e){this.dialog.open(le,{width:"400px",data:{userId:this.userId,companyId:void 0,treeTypeId:e.treeTypeId}}).afterClosed().subscribe(i=>{i?.updated&&this.loadUserTrees(this.userId)})}static{this.\u0275fac=function(n){return new(n||t)(E(ie),E(q),E(G),E(ae),E(k),E(oe),E(V),E(re),E($))}}static{this.\u0275cmp=w({type:t,selectors:[["app-user-form"]],standalone:!0,features:[B],decls:73,vars:63,consts:[["noPlantedTrees",""],[1,"w-full","max-w-full","mx-auto","bg-white","p-6","rounded-2xl","shadow-lg"],[1,"text-2xl","font-bold","text-green-700","text-center","mb-6"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-4",3,"ngSubmit","formGroup"],[1,"md:col-span-2","flex","flex-col","items-center","mb-4"],["alt","Avatar",1,"w-24","h-24","rounded-full","shadow-lg","mb-2","object-cover",3,"src"],[1,"cursor-pointer","bg-gray-200","hover:bg-gray-300","p-2","rounded-full","flex","items-center","gap-2"],[1,"material-icons"],["type","file","accept","image/*","hidden","",3,"change"],[1,"md:col-span-2"],[1,"block","text-gray-700","font-medium","mb-1"],["type","text","formControlName","name",1,"w-full","rounded-xl","border","border-gray-300","px-4","py-2","shadow-sm","focus:outline-none","focus:ring-2","focus:ring-green-500","focus:border-transparent","transition",3,"placeholder"],["class","text-red-500 text-sm mt-1",4,"ngIf"],["type","text","formControlName","surname",1,"w-full","rounded-xl","border","border-gray-300","px-4","py-2","shadow-sm","focus:outline-none","focus:ring-2","focus:ring-green-500","focus:border-transparent","transition",3,"placeholder"],["type","text","formControlName","secondSurname",1,"w-full","rounded-xl","border","border-gray-300","px-4","py-2","shadow-sm","focus:outline-none","focus:ring-2","focus:ring-green-500","focus:border-transparent","transition",3,"placeholder"],["type","email","formControlName","email",1,"w-full","rounded-xl","border","border-gray-300","px-4","py-2","shadow-sm","focus:outline-none","focus:ring-2","focus:ring-green-500","focus:border-transparent","transition",3,"placeholder"],["formControlName","role",1,"w-full","rounded-xl","border","border-gray-300","px-4","py-2","shadow-sm","focus:outline-none","focus:ring-2","focus:ring-green-500","focus:border-transparent","transition"],["value",""],[3,"value",4,"ngFor","ngForOf"],[4,"ngIf"],[1,"md:col-span-2","mt-4","flex","gap-4"],["type","button",1,"flex-1","bg-gray-300","text-gray-700","py-3","rounded-xl","hover:bg-gray-400","transition",3,"click"],["type","submit",1,"flex-1","bg-green-600","text-white","py-3","rounded-xl","hover:bg-green-700","disabled:opacity-50","transition"],[1,"mt-4","w-full","text-left"],[1,"flex","justify-between","items-center","mb-2"],[1,"font-semibold","text-gray-700"],["class","bg-red-600 text-white text-xs px-2 py-0.5 rounded-full",4,"ngIf"],["type","button","class","bg-green-200 text-green-800 px-3 py-1 rounded-full hover:bg-green-300 transition text-sm",3,"click",4,"ngIf"],[4,"ngIf","ngIfElse"],["class","text-center text-green-600 font-semibold text-lg mt-4",4,"ngIf"],["class","text-center text-red-500 mt-4",4,"ngIf"],[1,"text-red-500","text-sm","mt-1"],[3,"value"],["formControlName","companyId",1,"w-full","rounded-xl","border","border-gray-300","px-4","py-2","shadow-sm","focus:outline-none","focus:ring-2","focus:ring-green-500","focus:border-transparent","disabled:bg-gray-100","disabled:cursor-not-allowed","transition"],[1,"bg-red-600","text-white","text-xs","px-2","py-0.5","rounded-full"],["type","button",1,"bg-green-200","text-green-800","px-3","py-1","rounded-full","hover:bg-green-300","transition","text-sm",3,"click"],["class","flex justify-between border-b py-1",4,"ngFor","ngForOf"],[1,"flex","justify-between","border-b","py-1"],[1,"block","font-semibold"],[1,"text-sm","text-gray-500"],["type","button","class","bg-red-200 text-red-800 px-3 py-1 rounded-full hover:bg-red-300 transition text-sm",3,"click",4,"ngIf"],["type","button",1,"bg-red-200","text-red-800","px-3","py-1","rounded-full","hover:bg-red-300","transition","text-sm",3,"click"],[1,"text-gray-500","italic"],[1,"text-center","text-green-600","font-semibold","text-lg","mt-4"],[1,"text-center","text-red-500","mt-4"]],template:function(n,i){if(n&1){let u=F();a(0,"div",1)(1,"h2",2),s(2),l(3,"translate"),l(4,"translate"),o(),a(5,"form",3),U("ngSubmit",function(){return b(u),y(i.onSubmit())}),a(6,"div",4),C(7,"img",5),a(8,"label",6)(9,"span",7),s(10,"photo_camera"),o(),a(11,"span"),s(12),l(13,"translate"),o(),a(14,"input",8),U("change",function(x){return b(u),y(i.onFileSelected(x))}),o()()(),a(15,"div",9)(16,"label",10),s(17),l(18,"translate"),o(),C(19,"input",11),l(20,"translate"),g(21,de,3,3,"div",12),o(),a(22,"div")(23,"label",10),s(24),l(25,"translate"),o(),C(26,"input",13),l(27,"translate"),g(28,pe,3,3,"div",12),o(),a(29,"div")(30,"label",10),s(31),l(32,"translate"),o(),C(33,"input",14),l(34,"translate"),o(),a(35,"div",9)(36,"label",10),s(37),l(38,"translate"),o(),C(39,"input",15),l(40,"translate"),g(41,ue,3,2,"div",12),o(),a(42,"div")(43,"label",10),s(44),l(45,"translate"),o(),a(46,"select",16)(47,"option",17),s(48),l(49,"translate"),o(),g(50,fe,2,2,"option",18),o(),g(51,ge,3,3,"div",12),o(),g(52,Ee,10,8,"div",19),a(53,"div",20)(54,"button",21),U("click",function(){return b(u),y(i.onCancel())}),s(55),l(56,"translate"),o(),a(57,"button",22),s(58),l(59,"translate"),l(60,"translate"),o()()(),a(61,"div",23)(62,"div",24)(63,"p",25),s(64),l(65,"translate"),g(66,ve,2,1,"span",26),o(),g(67,xe,3,3,"button",27),o(),g(68,be,2,1,"ul",28)(69,ye,3,3,"ng-template",null,0,L),o(),g(71,Ce,3,3,"div",29)(72,Ue,2,1,"div",30),o()}if(n&2){let u,f,x,I,A,R=M(70);r(2),_(" ",i.isEditMode?d(3,29,"USER.EDIT_TITLE"):d(4,31,"USER.NEW_TITLE")," "),r(3),p("formGroup",i.userForm),r(2),p("src",i.previewImage||"assets/logo-white.png",N),r(5),c(d(13,33,"USER.SELECT_IMAGE")),r(5),c(d(18,35,"USER.NAME_LABEL")),r(2),p("placeholder",d(20,37,"USER.NAME_PLACEHOLDER")),r(2),p("ngIf",((u=i.userForm.get("name"))==null?null:u.invalid)&&((u=i.userForm.get("name"))==null?null:u.touched)),r(3),c(d(25,39,"USER.SURNAME_LABEL")),r(2),p("placeholder",d(27,41,"USER.SURNAME_PLACEHOLDER")),r(2),p("ngIf",((f=i.userForm.get("surname"))==null?null:f.invalid)&&((f=i.userForm.get("surname"))==null?null:f.touched)),r(3),c(d(32,43,"USER.SECOND_SURNAME_LABEL")),r(2),p("placeholder",d(34,45,"USER.SECOND_SURNAME_PLACEHOLDER")),r(4),c(d(38,47,"USER.EMAIL_LABEL")),r(2),p("placeholder",d(40,49,"USER.EMAIL_PLACEHOLDER")),r(2),p("ngIf",((x=i.userForm.get("email"))==null?null:x.invalid)&&((x=i.userForm.get("email"))==null?null:x.touched)),r(3),c(d(45,51,"USER.ROLE_LABEL")),r(4),c(d(49,53,"USER.SELECT_ROLE")),r(2),p("ngForOf",i.roles),r(),p("ngIf",((I=i.userForm.get("role"))==null?null:I.invalid)&&((I=i.userForm.get("role"))==null?null:I.touched)),r(),p("ngIf",i.showCompanySelectorDynamic()),r(3),_(" ",d(56,55,"USER.CANCEL_BUTTON")," "),r(3),_(" ",i.isEditMode?d(59,57,"USER.EDIT_BUTTON"):d(60,59,"USER.CREATE_BUTTON")," "),r(6),_("",d(65,61,"LANDS.PLANTED_TREES_BY_USER")," "),r(2),p("ngIf",((A=i.user==null?null:i.user.pendingTreesCount)!==null&&A!==void 0?A:0)>0),r(),p("ngIf",i.isAdmin),r(),p("ngIf",i.plantedTrees==null?null:i.plantedTrees.length)("ngIfElse",R),r(3),p("ngIf",i.registerSuccess),r(),p("ngIf",i.registerError)}},dependencies:[P,D,O,ne,J,ee,te,z,Z,H,W,K,X,j,Y,Q],styles:["[_nghost-%COMP%]{display:block;min-height:calc(100vh - 4rem);padding-top:2rem;background-color:#f3f4f6}input[_ngcontent-%COMP%], select[_ngcontent-%COMP%]{transition:border-color .2s}"]})}}return t})();export{Qe as UserFormComponent};
