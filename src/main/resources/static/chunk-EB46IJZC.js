import{C as i,a as p,b as f,dc as A,ec as b,g as d,h as m,hc as I,i as g,ic as j,j as a,k as u,kc as y,mb as U,mc as P,p as l,u as S,ub as v,w as C,z as c}from"./chunk-4KXJWRUC.js";var n=function(o){return o.ADMIN="ADMIN",o.USER="USER",o.COMPANY_ADMIN="COMPANY_ADMIN",o.COMPANY_USER="COMPANY_USER",o}(n||{}),B=[{value:n.ADMIN,label:"Administrador"},{value:n.USER,label:"Usuario"},{value:n.COMPANY_ADMIN,label:"Administrador de Compa\xF1\xEDa"},{value:n.COMPANY_USER,label:"Usuario de Compa\xF1\xEDa"}];var L=(()=>{class o{constructor(e,r){this.authApi=e,this.router=r,this.userSubject=new d(null),this.user$=this.userSubject.asObservable();let t=localStorage.getItem("forestPlus_user");t&&this.userSubject.next(JSON.parse(t))}isLoggedIn(){return this.userSubject.value!==null}logout(){localStorage.removeItem("forestPlus_token"),localStorage.removeItem("forestPlus_user"),this.userSubject.next(null),this.router.navigate(["/login"])}getUser(){return this.userSubject.value}setUser(e,r){let t;e instanceof Blob?e.text().then(s=>{try{t=JSON.parse(s),this.applyUser(t,r)}catch(h){console.error("\u274C Error al parsear usuario desde Blob:",h)}}):(t=e,this.applyUser(t,r))}applyUser(e,r){this.userSubject.next(e),localStorage.setItem("forestPlus_user",JSON.stringify(e)),r&&localStorage.setItem("forestPlus_token",r)}login(e){return this.authApi.login(e).pipe(S(r=>{if(!r.user)throw new Error("No se recibi\xF3 el usuario en la respuesta del login");return r.user instanceof Blob?m(r.user.text()).pipe(u(t=>JSON.parse(t)),C(t=>this.setUser(t,r.token))):(this.setUser(r.user,r.token),g(r.user))}),l(r=>(console.error("Error login",r),a(()=>r))))}register(e){return this.authApi.register(e).pipe(u(r=>{let t=r;if(!t)throw new Error("No se recibi\xF3 el usuario tras el registro");return this.setUser(t),t}),l(r=>a(()=>r)))}forgotPassword(e){return this.authApi.forgotPassword({email:e}).pipe(l(r=>a(()=>r)))}resetPassword(e,r){if(r)return this.authApi.resetForgotPassword(r,e);let t=localStorage.getItem("forestPlus_token");if(!t)throw new Error("No hay token de usuario logueado");let s=`Bearer ${t}`;return this.authApi.resetPassword(s,e)}verifyEmail(e){return this.authApi.verifyEmail(e).pipe(l(r=>a(()=>r)))}updateCurrentUser(e){let r=localStorage.getItem("forestPlus_token");this.setUser(e,r??void 0)}resendVerification(e){return this.authApi.resendVerification({email:e})}resetForgotPassword(e,r){return this.authApi.resetForgotPassword(e,r)}refreshToken(){let e=localStorage.getItem("forestPlus_refresh_token");return e?this.authApi.refreshToken({refreshToken:e}).pipe(u(r=>{if(!r.user||!r.token)throw new Error("Refresh failed: no token/user received");return this.setUser(r.user,r.token),r.refreshToken&&localStorage.setItem("forestPlus_refresh_token",r.refreshToken),r}),l(r=>(this.logout(),a(()=>r)))):(this.logout(),a(()=>new Error("No refresh token found")))}get currentUserRole(){return this.userSubject.value?.role??null}get currentUserCompanyId(){return this.userSubject.value?.company?.id??null}static{this.\u0275fac=function(r){return new(r||o)(i(b),i(v))}}static{this.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();var R=(()=>{class o{constructor(e,r,t){this.userController=e,this.http=r,this.authService=t,this.user$=this.authService.user$}getUser(){return this.authService.user$}updateCurrentUser(e){this.authService.updateCurrentUser(e)}getCurrentUser(){return this.authService.getUser()}getCurrentUser$(){return this.authService.user$}getUsers(e=0,r=10,t="id,asc",s,h){return this.userController.getUsers(s,h,e,r,t)}getUserById(e){return this.userController.getUserById(e)}updateUser(e,r){return this.userController.updateUser(e,r).pipe(u(t=>(this.getCurrentUser()?.id===t.id&&this.authService.updateCurrentUser(t),t)))}updateUserByAdmin(e,r){return this.userController.updateUserByAdmin(e,r)}registerUserByAdmin(e){return this.userController.registerUserByAdmin(e)}deleteUser(e){return this.userController.deleteUser(e)}isAdminOrCompanyAdmin(){let e=this.getCurrentUser();return!!e&&(e.role===n.ADMIN||e.role===n.COMPANY_ADMIN)}updateUserPicture(e,r){let t=new FormData;return t.append("file",r),this.http.put(`${A.apiBaseUrl}/api/users/${e}/picture`,t).pipe(u(s=>(this.getCurrentUser()?.id===s.id&&this.authService.updateCurrentUser(s),s)))}static{this.\u0275fac=function(r){return new(r||o)(i(P),i(U),i(L))}}static{this.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();var J=(()=>{class o{constructor(e,r,t){this.landController=e,this.coordinateController=r,this.treeController=t,this.landSubject=new d(null);let s=localStorage.getItem("forestPlus_land");s&&this.landSubject.next(JSON.parse(s))}getLand(){return this.landSubject.asObservable()}getCurrentLand(){return this.landSubject.value}updateCurrentLand(e){this.landSubject.next(e),localStorage.setItem("forestPlus_land",JSON.stringify(e))}clearLand(){this.landSubject.next(null),localStorage.removeItem("forestPlus_land")}getAllLands(){return this.landController.getAllLands()}getLandById(e){return this.landController.getLandById(e)}createLand(e){return this.landController.createLand(e)}updateLand(e,r){return this.landController.updateLand(e,r)}deleteLand(e){return this.landController.deleteLand(e)}getCoordinatesByLand(e){return this.coordinateController.getCoordinatesByLand(e)}createCoordinate(e,r){return this.coordinateController.createCoordinate(f(p({},r),{landId:e}))}deleteCoordinate(e){return this.coordinateController.deleteCoordinate(e)}getTreesByLand(e){return this.treeController.getTreesByLand(e)}static{this.\u0275fac=function(r){return new(r||o)(i(j),i(I),i(y))}}static{this.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();export{n as a,B as b,L as c,R as d,J as e};
