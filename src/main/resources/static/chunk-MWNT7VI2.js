import{c as w,d as O,e as X}from"./chunk-V2GV6NUA.js";import{$ as A,$a as R,Ac as _,Ad as Z,Bb as D,Cc as k,Dc as q,Fa as C,Gc as z,Ha as x,Ic as G,Jc as Q,K as F,Kc as H,Lc as $,Mc as W,Oc as J,Qc as K,Sa as l,Ta as c,Ua as E,aa as r,ba as g,bb as s,cb as p,ja as u,mc as v,na as d,nb as M,nc as y,ob as N,rc as T,sb as B,sc as P,wa as a,xa as o,xc as V,ya as b,yc as Y,zb as L,zc as j}from"./chunk-QLNJI7UZ.js";function ee(i,m){i&1&&(a(0,"div",23),l(1),s(2,"translate"),o()),i&2&&(r(),c(p(2,1,"USER.FIELD_REQUIRED")))}function te(i,m){i&1&&(a(0,"div",23),l(1),s(2,"translate"),o()),i&2&&(r(),c(p(2,1,"USER.FIELD_REQUIRED")))}function ie(i,m){i&1&&(a(0,"div"),l(1),s(2,"translate"),o()),i&2&&(r(),c(p(2,1,"USER.FIELD_REQUIRED")))}function re(i,m){i&1&&(a(0,"div"),l(1),s(2,"translate"),o()),i&2&&(r(),E("",p(2,1,"USER.INVALID_EMAIL")," "))}function ne(i,m){if(i&1&&(a(0,"div",23),u(1,ie,3,3,"div",17)(2,re,3,3,"div",17),o()),i&2){let t,e,n=x();r(),d("ngIf",(t=n.userForm.get("email"))==null?null:t.hasError("required")),r(),d("ngIf",(e=n.userForm.get("email"))==null?null:e.hasError("email"))}}function oe(i,m){if(i&1&&(a(0,"option",24),l(1),o()),i&2){let t=m.$implicit;d("value",t.value),r(),c(t.label)}}function ae(i,m){i&1&&(a(0,"div",23),l(1),s(2,"translate"),o()),i&2&&(r(),E(" ",p(2,1,"USER.FIELD_REQUIRED")," "))}function le(i,m){if(i&1&&(a(0,"option",24),l(1),o()),i&2){let t=m.$implicit;d("value",t.id),r(),c(t.name)}}function se(i,m){i&1&&(a(0,"div",23),l(1),s(2,"translate"),o()),i&2&&(r(),E(" ",p(2,1,"USER.FIELD_REQUIRED")," "))}function pe(i,m){if(i&1&&(a(0,"div")(1,"label",8),l(2),s(3,"translate"),o(),a(4,"select",25)(5,"option",15),l(6),s(7,"translate"),o(),u(8,le,2,2,"option",16),o(),u(9,se,3,3,"div",10),o()),i&2){let t,e=x();r(2),c(p(3,5,"USER.COMPANY_LABEL")),r(2),d("disabled",e.isCompanyAdmin),r(2),c(p(7,7,"USER.SELECT_COMPANY")),r(2),d("ngForOf",e.companies),r(),d("ngIf",((t=e.userForm.get("companyId"))==null?null:t.invalid)&&((t=e.userForm.get("companyId"))==null?null:t.touched))}}function de(i,m){i&1&&(a(0,"div",26),l(1," Una vez creado el usuario 'administrador de compa\xF1\xEDa' podr\xE1s asignarlo a una compa\xF1\xEDa existente o de nueva creaci\xF3n. "),o())}function me(i,m){i&1&&(a(0,"div",27),l(1),s(2,"translate"),o()),i&2&&(r(),E(" ",p(2,1,"USER.SUCCESS_MSG")," "))}function ce(i,m){if(i&1&&(a(0,"div",28),l(1),o()),i&2){let t=x();r(),E(" ",t.registerError," ")}}var Ae=(()=>{class i{constructor(t,e,n,f,h,S,I){this.fb=t,this.userService=e,this.authService=n,this.companyService=f,this.router=h,this.snackBar=S,this.route=I,this.hidePassword=!0,this.roles=y,this.companies=[],this.registerSuccess=!1,this.registerError="",this.isEditMode=!1,this.isSelfEdit=!1,this.RolesEnum=v,this.isCompanyAdmin=!1,this.showCompanySelector=!1}ngOnInit(){this.currentUser=this.authService.getUser()??void 0,this.isCompanyAdmin=this.currentUser?.role===v.COMPANY_ADMIN,this.showCompanySelector=!1,this.userForm=this.fb.group({name:["",_.required],surname:["",_.required],secondSurname:[""],email:["",[_.required,_.email]],password:["",[_.minLength(6)]],role:[null,_.required],companyId:[""]}),this.route.paramMap.subscribe(t=>{let e=t.get("id");e&&(this.isEditMode=!0,this.userId=+e,this.loadUser(this.userId))}),this.configureAvailableRoles(),this.isCompanyAdmin?(this.showCompanySelector=!0,this.userForm.get("companyId")?.disable(),this.companyService.getAllCompanies().subscribe({next:t=>{this.companies=t.filter(n=>n.users?.some(f=>f.role===v.COMPANY_ADMIN));let e=this.currentUser?.company?.id;e&&this.userForm.patchValue({companyId:e})},error:t=>console.error("Error cargando compa\xF1\xEDas",t)})):this.loadCompanies(),this.userForm.get("role")?.valueChanges.subscribe(t=>{let e=this.userForm.get("companyId");t===v.COMPANY_USER||this.isCompanyAdmin?(this.showCompanySelector=!0,e?.setValidators([_.required]),this.isCompanyAdmin||e?.enable()):(this.showCompanySelector=!1,e?.clearValidators(),this.isCompanyAdmin||(e?.setValue(""),e?.disable())),e?.updateValueAndValidity()})}configureAvailableRoles(){this.currentUser&&(this.currentUser.role===v.ADMIN?this.roles=y:this.currentUser.role===v.COMPANY_ADMIN&&(this.roles=y.filter(t=>t.value===v.COMPANY_ADMIN||t.value===v.COMPANY_USER)))}loadCompanies(){this.companyService.getAllCompanies().subscribe({next:t=>{this.companies=t.filter(e=>e.users?.some(n=>n.role===v.COMPANY_ADMIN))},error:t=>console.error("Error cargando compa\xF1\xEDas",t)})}loadUser(t){this.userService.getUserById(t).subscribe({next:e=>{this.user=e,this.previewImage=e.picture,this.isSelfEdit=this.currentUser?.id===this.userId,this.userForm.patchValue({name:e.name,surname:e.surname,secondSurname:e.secondSurname,email:e.email,role:e.role,companyId:e.company?.id??""}),this.isSelfEdit?(this.userForm.get("role")?.disable(),this.userForm.get("companyId")?.disable(),this.userForm.get("password")?.disable()):this.userForm.get("email")?.disable()},error:e=>console.error("\u274C Error al cargar usuario",e)})}onFileSelected(t){let e=t.target.files[0];if(e){this.selectedFile=e;let n=new FileReader;n.onload=()=>this.previewImage=n.result,n.readAsDataURL(e)}}onSubmit(){if(this.userForm.invalid)return;let t=this.userForm.getRawValue();this.isCompanyAdmin&&(t.companyId=this.currentUser?.company?.id??void 0);let e;this.selectedFile&&this.isEditMode?e=this.userService.updateUserPicture(this.userId,this.selectedFile):this.isEditMode?e=this.isSelfEdit?this.userService.updateUser(this.userId,t):this.userService.updateUserByAdmin(this.userId,t):e=this.userService.registerUserByAdmin(t),e.subscribe({next:n=>{this.finalizeUpdate(n)},error:n=>{this.registerError=n.error?.message||"Error al guardar usuario",this.registerSuccess=!1,console.error(n)}})}finalizeUpdate(t){this.user=t,this.previewImage=t.picture,this.selectedFile=void 0,this.snackBar.open("\u2705 Usuario actualizado con \xE9xito","Cerrar",{duration:3e3}),this.isSelfEdit?(this.authService.updateCurrentUser(t),this.router.navigate(["/profile"])):this.router.navigate(["/admin/users"])}static{this.\u0275fac=function(e){return new(e||i)(g(J),g(P),g(T),g(Z),g(D),g(X),g(L))}}static{this.\u0275cmp=F({type:i,selectors:[["app-user-form"]],standalone:!0,features:[R],decls:61,vars:51,consts:[[1,"max-w-2xl","mx-auto","bg-white","p-6","rounded-2xl","shadow-lg"],[1,"text-2xl","font-bold","text-green-700","text-center","mb-6"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-4",3,"ngSubmit","formGroup"],[1,"md:col-span-2","flex","flex-col","items-center","mb-4"],["alt","Avatar",1,"w-24","h-24","rounded-full","shadow-lg","mb-2",3,"src"],[1,"cursor-pointer","bg-gray-200","hover:bg-gray-300","p-2","rounded-full","flex","items-center","gap-2"],["type","file","accept","image/*","hidden","",3,"change"],[1,"md:col-span-2"],[1,"block","text-gray-700","mb-1"],["type","text","formControlName","name",1,"w-full","px-4","py-2","border-b","border-gray-300","focus:border-green-500","focus:outline-none","bg-transparent",3,"placeholder"],["class","text-red-500 text-sm mt-1",4,"ngIf"],["type","text","formControlName","surname",1,"w-full","px-4","py-2","border-b","border-gray-300","focus:border-green-500","focus:outline-none","bg-transparent",3,"placeholder"],["type","text","formControlName","secondSurname",1,"w-full","px-4","py-2","border-b","border-gray-300","focus:border-green-500","focus:outline-none","bg-transparent",3,"placeholder"],["type","email","formControlName","email",1,"w-full","px-4","py-2","border-b","border-gray-300","focus:border-green-500","focus:outline-none","bg-transparent",3,"placeholder"],["formControlName","role",1,"w-full","px-4","py-2","border-b","border-gray-300","focus:border-green-500","focus:outline-none","bg-transparent"],["value",""],[3,"value",4,"ngFor","ngForOf"],[4,"ngIf"],["class","text-blue-500 text-sm mt-1",4,"ngIf"],[1,"md:col-span-2","mt-4"],["type","submit",1,"w-full","bg-green-600","text-white","py-3","rounded-lg","hover:bg-green-700","disabled:opacity-50"],["class","text-center text-green-600 font-semibold text-lg mt-4",4,"ngIf"],["class","text-center text-red-500 mt-4",4,"ngIf"],[1,"text-red-500","text-sm","mt-1"],[3,"value"],["formControlName","companyId",1,"w-full","px-4","py-2","border-b","border-gray-300","focus:border-green-500","focus:outline-none","bg-transparent","disabled:bg-gray-100","disabled:cursor-not-allowed",3,"disabled"],[1,"text-blue-500","text-sm","mt-1"],[1,"text-center","text-green-600","font-semibold","text-lg","mt-4"],[1,"text-center","text-red-500","mt-4"]],template:function(e,n){if(e&1&&(a(0,"div",0)(1,"h2",1),l(2),s(3,"translate"),s(4,"translate"),o(),a(5,"form",2),C("ngSubmit",function(){return n.onSubmit()}),a(6,"div",3),b(7,"img",4),a(8,"label",5)(9,"mat-icon"),l(10,"photo_camera"),o(),a(11,"span"),l(12,"Seleccionar foto"),o(),a(13,"input",6),C("change",function(h){return n.onFileSelected(h)}),o()()(),a(14,"div",7)(15,"label",8),l(16),s(17,"translate"),o(),b(18,"input",9),s(19,"translate"),u(20,ee,3,3,"div",10),o(),a(21,"div")(22,"label",8),l(23),s(24,"translate"),o(),b(25,"input",11),s(26,"translate"),u(27,te,3,3,"div",10),o(),a(28,"div")(29,"label",8),l(30),s(31,"translate"),o(),b(32,"input",12),s(33,"translate"),o(),a(34,"div",7)(35,"label",8),l(36),s(37,"translate"),o(),b(38,"input",13),s(39,"translate"),u(40,ne,3,2,"div",10),o(),a(41,"div")(42,"label",8),l(43),s(44,"translate"),o(),a(45,"select",14)(46,"option",15),l(47),s(48,"translate"),o(),u(49,oe,2,2,"option",16),o(),u(50,ae,3,3,"div",10),o(),u(51,pe,10,9,"div",17)(52,de,2,0,"div",18),a(53,"div",19)(54,"button",20),l(55),s(56,"translate"),s(57,"translate"),o()()(),u(58,me,3,3,"div",21)(59,ce,2,1,"div",22),o(),l(60,"\n``")),e&2){let f,h,S,I,U;r(2),E(" ",n.isEditMode?p(3,23,"USER.EDIT_TITLE"):p(4,25,"USER.NEW_TITLE")," "),r(3),d("formGroup",n.userForm),r(2),d("src",n.previewImage||"assets/logo-white.png",A),r(9),c(p(17,27,"USER.NAME_LABEL")),r(2),d("placeholder",p(19,29,"USER.NAME_PLACEHOLDER")),r(2),d("ngIf",((f=n.userForm.get("name"))==null?null:f.invalid)&&((f=n.userForm.get("name"))==null?null:f.touched)),r(3),c(p(24,31,"USER.SURNAME_LABEL")),r(2),d("placeholder",p(26,33,"USER.SURNAME_PLACEHOLDER")),r(2),d("ngIf",((h=n.userForm.get("surname"))==null?null:h.invalid)&&((h=n.userForm.get("surname"))==null?null:h.touched)),r(3),c(p(31,35,"USER.SECOND_SURNAME_LABEL")),r(2),d("placeholder",p(33,37,"USER.SECOND_SURNAME_PLACEHOLDER")),r(4),c(p(37,39,"USER.EMAIL_LABEL")),r(2),d("placeholder",p(39,41,"USER.EMAIL_PLACEHOLDER")),r(2),d("ngIf",((S=n.userForm.get("email"))==null?null:S.invalid)&&((S=n.userForm.get("email"))==null?null:S.touched)),r(3),c(p(44,43,"USER.ROLE_LABEL")),r(4),c(p(48,45,"USER.SELECT_ROLE")),r(2),d("ngForOf",n.roles),r(),d("ngIf",((I=n.userForm.get("role"))==null?null:I.invalid)&&((I=n.userForm.get("role"))==null?null:I.touched)),r(),d("ngIf",n.showCompanySelector),r(),d("ngIf",((U=n.userForm.get("role"))==null?null:U.value)===n.RolesEnum.COMPANY_ADMIN&&!n.isCompanyAdmin),r(3),E(" ",n.isEditMode?p(56,47,"USER.EDIT_BUTTON"):p(57,49,"USER.CREATE_BUTTON")," "),r(3),d("ngIf",n.registerSuccess),r(),d("ngIf",n.registerError)}},dependencies:[B,M,N,K,z,$,W,j,H,k,q,G,Q,O,w,Y,V],styles:["[_nghost-%COMP%]{display:block;min-height:calc(100vh - 4rem);padding-top:2rem;background-color:#f3f4f6}input[_ngcontent-%COMP%], select[_ngcontent-%COMP%]{transition:border-color .2s}"]})}}return i})();export{Ae as UserFormComponent};
