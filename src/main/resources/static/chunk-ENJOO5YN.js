import{a as X,b as Z,c as de,d as me,e as le,f as ce,g as pe,h as ue,i as fe,j as he,k as R,l as _e,m as ge,n as ve}from"./chunk-3P5MD5LR.js";import{$a as g,Aa as a,Ac as ie,Ba as n,Ca as w,Dc as ne,Eb as $,F as W,Ga as Y,Gb as J,Gc as oe,I as N,Ic as ae,Ja as _,La as l,Lc as re,M as P,Nc as se,S as u,T as f,Wa as r,Xa as B,Ya as C,a as T,ab as v,bb as y,db as j,ea as d,fa as b,fb as A,hb as V,j as M,mc as K,na as E,q as O,qb as L,ra as c,rb as q,sb as U,t as S,tc as H,vb as z,wb as G,wc as Q,xc as ee,yd as Ce,zc as te}from"./chunk-UX3E3RBF.js";var ye=(()=>{class m{constructor(e){this.co2Api=e}getAll(e){return this.co2Api.getAll(e)}save(e,t){return this.co2Api.createOrUpdate(e,t)}delete(e,t){return this.co2Api._delete(e,t)}static{this.\u0275fac=function(t){return new(t||m)(N(H))}}static{this.\u0275prov=W({token:m,factory:m.\u0275fac,providedIn:"root"})}}return m})();function Se(m,x){if(m&1){let e=Y();a(0,"div",30)(1,"mat-form-field",12)(2,"mat-label"),r(3,"Emitido"),n(),a(4,"input",31),y("ngModelChange",function(i){u(e);let o=l(2);return v(o.co2Years[0].editEmissions,i)||(o.co2Years[0].editEmissions=i),f(i)}),n()(),a(5,"mat-form-field",12)(6,"mat-label"),r(7,"Compensado"),n(),a(8,"input",31),y("ngModelChange",function(i){u(e);let o=l(2);return v(o.co2Years[0].editCompensations,i)||(o.co2Years[0].editCompensations=i),f(i)}),n()(),a(9,"button",8),_("click",function(){u(e);let i=l(2);return f(i.saveCO2(i.co2Years[0]))}),r(10,"Guardar"),n()()}if(m&2){let e=l(2);d(4),g("ngModel",e.co2Years[0].editEmissions),d(4),g("ngModel",e.co2Years[0].editCompensations)}}function Ye(m,x){if(m&1){let e=Y();a(0,"div",30)(1,"mat-form-field",12)(2,"mat-label"),r(3,"Emitido"),n(),a(4,"input",31),y("ngModelChange",function(i){u(e);let o=l().$implicit;return v(o.editEmissions,i)||(o.editEmissions=i),f(i)}),n()(),a(5,"mat-form-field",12)(6,"mat-label"),r(7,"Compensado"),n(),a(8,"input",31),y("ngModelChange",function(i){u(e);let o=l().$implicit;return v(o.editCompensations,i)||(o.editCompensations=i),f(i)}),n()(),a(9,"button",8),_("click",function(){u(e);let i=l().$implicit,o=l(2);return f(o.saveCO2(i))}),r(10,"Guardar"),n()()}if(m&2){let e=l().$implicit;d(4),g("ngModel",e.editEmissions),d(4),g("ngModel",e.editCompensations)}}function Fe(m,x){if(m&1){let e=Y();a(0,"div",32)(1,"h3",17),r(2),n(),a(3,"div",18)(4,"button",19),_("click",function(){let i=u(e).$implicit,o=l(2);return f(o.toggleEditCO2(i))}),r(5),n()(),E(6,Ye,11,2,"div",20),a(7,"div",21)(8,"div",22),w(9,"canvas",33),n(),a(10,"div",22),w(11,"canvas",33),n(),a(12,"div",25)(13,"div",34),r(14),A(15,"number"),n(),a(16,"div",27),r(17,"Toneladas de CO\u2082"),n(),a(18,"div",28),r(19),n()()()()}if(m&2){let e=x.$implicit,t=l(2);d(2),C("A\xF1o ",e.year,""),d(3),C(" ",e.editMode?"Cancelar":"Editar"," "),d(),c("ngIf",e.editMode),d(3),c("id",e.emitidoRef),d(2),c("id",e.compensadoRef),d(2),c("ngClass",t.getNetColorClass(e.totalEmissions,e.totalCompensations)),d(),C(" ",V(15,8,e.totalEmissions-e.totalCompensations,"1.0-0")," "),d(5),C(" (has compensado el ",t.getCompensatedPercentage(e.totalEmissions,e.totalCompensations),"% de tus emisiones) ")}}function Ie(m,x){if(m&1){let e=Y();a(0,"div")(1,"h2",15),r(2,"Emisiones de CO\u2082 por a\xF1o"),n(),a(3,"div",16)(4,"h3",17),r(5),n(),a(6,"div",18)(7,"button",19),_("click",function(){u(e);let i=l();return f(i.toggleEditCO2(i.co2Years[0]))}),r(8),n()(),E(9,Se,11,2,"div",20),a(10,"div",21)(11,"div",22)(12,"div",23),r(13,"Emitido"),n(),w(14,"canvas",24),n(),a(15,"div",22)(16,"div",23),r(17,"Compensado"),n(),w(18,"canvas",24),n(),a(19,"div",25)(20,"div",23),r(21,"Valor Neto"),n(),a(22,"div",26),r(23),A(24,"number"),n(),a(25,"div",27),r(26,"Toneladas de CO\u2082"),n(),a(27,"div",28),r(28),n()()()(),E(29,Fe,20,11,"div",29),n()}if(m&2){let e=l();d(5),C("\xDAltimo a\xF1o registrado: ",e.co2Years[0].year,""),d(3),C(" ",e.co2Years[0].editMode?"Cancelar":"Editar"," "),d(),c("ngIf",e.co2Years[0].editMode),d(5),c("id",e.co2Years[0].emitidoRef),d(4),c("id",e.co2Years[0].compensadoRef),d(4),c("ngClass",e.getNetColorClass(e.co2Years[0].totalEmissions,e.co2Years[0].totalCompensations)),d(),C(" ",V(24,9,e.co2Years[0].totalEmissions-e.co2Years[0].totalCompensations,"1.0-0")," "),d(5),C(" (has compensado el ",e.getCompensatedPercentage(e.co2Years[0].totalEmissions,e.co2Years[0].totalCompensations),"% de tus emisiones) "),d(),c("ngForOf",e.co2Years.slice(1))}}function Te(m,x){if(m&1&&(a(0,"mat-option",35),r(1),n()),m&2){let e=x.$implicit;c("value",e),d(),B(e)}}var Xe=(()=>{class m{constructor(e,t,i,o,s){this.companyService=e,this.companyCo2Service=t,this.route=i,this.router=o,this.userService=s,this.editData={},this.co2Years=[],this.chartsMap={},this.availableYears=[],R.register(he,_e,ve,ge)}ngOnInit(){let e=Number(this.route.snapshot.paramMap.get("id"));e&&(this.userService.getUser().subscribe(t=>{this.user=t}),this.companyService.getCompanyById(e).subscribe(t=>{this.company=t,this.editData=T({},t),this.prepareCO2Years(),this.updateAvailableYears()}))}onFileSelected(e){let t=e.target.files[0];if(!t)return;this.selectedFile=t;let i=new FileReader;i.onload=()=>this.previewImage=i.result,i.readAsDataURL(t)}saveChanges(){if(!this.company?.id)return;let e=[];this.selectedFile&&e.push(this.companyService.updateCompanyPicture(this.company.id,this.selectedFile).pipe(S(t=>(console.error(t),M(this.company))))),(this.editData.name||this.editData.address)&&e.push(this.companyService.updateCompany(this.company.id,{name:this.editData.name,address:this.editData.address}).pipe(S(t=>(console.error(t),M(this.company))))),e.length&&O(e).subscribe(t=>{let i=t[t.length-1];this.company=i,this.editData=T({},i),this.selectedFile=void 0,this.previewImage=void 0,this.prepareCO2Years(),this.updateAvailableYears()})}prepareCO2Years(){if(!this.company?.co2?.length)return;let e=[...this.company.co2].filter(t=>t.year!==void 0).sort((t,i)=>i.year-t.year);this.co2Years=e.map(t=>({id:t.id,year:t.year,totalEmissions:t.totalEmissions||0,totalCompensations:t.totalCompensations||0,net:(t.totalEmissions||0)-(t.totalCompensations||0),emitidoRef:`emitido-${t.year}`,compensadoRef:`compensado-${t.year}`,netoRef:`neto-${t.year}`,editMode:!1,editEmissions:t.totalEmissions||0,editCompensations:t.totalCompensations||0})),setTimeout(()=>this.renderCO2Charts(),0)}toggleEditCO2(e){e.editMode?e._backup&&(e.totalEmissions=e._backup.emissions,e.totalCompensations=e._backup.compensations):e._backup={emissions:e.totalEmissions,compensations:e.totalCompensations},e.editMode=!e.editMode,setTimeout(()=>this.renderCO2Charts(),0)}saveCO2(e){if(!this.company?.id)return;let t=e.editEmissions??0,i=e.editCompensations??0;e.net=t-i;let o={year:e.year,totalEmissions:t,totalCompensations:i};this.companyCo2Service.save(this.company.id,o).subscribe({next:s=>{e.id=s.id,e.totalEmissions=t,e.totalCompensations=i,e.editMode=!1,this.renderCO2Charts(),this.updateAvailableYears()},error:s=>console.error("Error guardando CO\u2082",s)})}addNewYear(e){if(!e||!this.company?.id)return;let t={year:e,totalEmissions:0,totalCompensations:0,net:0,emitidoRef:`emitido-${e}`,compensadoRef:`compensado-${e}`,netoRef:`neto-${e}`,editMode:!0,editEmissions:0,editCompensations:0},i={year:e,totalEmissions:0,totalCompensations:0};this.companyCo2Service.save(this.company.id,i).subscribe({next:o=>{t.id=o.id,this.co2Years.push(t),this.co2Years.sort((s,h)=>h.year-s.year),this.selectedYear=void 0,this.updateAvailableYears(),setTimeout(()=>this.renderCO2Charts(),0)},error:o=>console.error("Error guardando nuevo a\xF1o CO\u2082",o)})}createDonutChart(e,t,i,o){let s=e.getContext("2d");if(!s)return;this.chartsMap[e.id]&&this.chartsMap[e.id].destroy();let h={id:"centerText",beforeDraw:Ee=>{let{ctx:p,width:k,height:I}=Ee;p&&(p.save(),p.font=`${I/100*20}px sans-serif`,p.fillStyle="#333",p.textBaseline="middle",p.fillText(`${t}`,k/2-p.measureText(`${t}`).width/2,I/2-10),p.font=`${I/100*8}px sans-serif`,p.fillStyle="#666",p.fillText("Toneladas de CO\u2082",k/2-p.measureText("Toneladas de CO\u2082").width/2,I/2+15),p.restore())}},D=o>0?o:1,F=t/D*100,xe={datasets:[{data:[F,100-F],backgroundColor:[i,"#e0e0e0"],cutout:"75%",borderWidth:0}]},be={responsive:!0,animation:{animateRotate:!0,animateScale:!0,duration:1e3},plugins:{legend:{display:!1},tooltip:{enabled:!1}}};this.chartsMap[e.id]=new R(s,{type:"doughnut",data:xe,options:be,plugins:[h]})}renderCO2Charts(){let e=["emitidoRef","compensadoRef","netoRef"];this.co2Years.forEach((t,i)=>{let o=i===0?200:80;e.forEach(s=>{let h=document.getElementById(t[s]);if(!h)return;h.width=o,h.height=o;let D=s==="emitidoRef"?t.totalEmissions:s==="compensadoRef"?t.totalCompensations:t.net,F=s==="emitidoRef"?"#fc4d03ff":s==="compensadoRef"?"#89de8cff":"#2c80c5cf";this.createDonutChart(h,D,F,t.totalEmissions||1)})})}updateAvailableYears(){let e=new Date().getFullYear(),t=this.co2Years.map(i=>i.year);this.availableYears=[];for(let i=2020;i<=e;i++)t.includes(i)||this.availableYears.push(i);this.availableYears.sort((i,o)=>o-i)}getNetColorClass(e,t){let i=e-t,o=e>0?i/e:1;return o<.5?"net-yellow":o<=1?"net-red":"net-green"}getCompensatedPercentage(e,t){return e?(t/e*100).toFixed(0):"0"}saveCompany(){if(!this.company?.id)return;let e=[];this.selectedFile&&e.push(this.companyService.updateCompanyPicture(this.company.id,this.selectedFile).pipe(S(t=>(console.error("Error actualizando imagen",t),M(this.company))))),(this.editData.name!==this.company.name||this.editData.address!==this.company.address)&&e.push(this.companyService.updateCompany(this.company.id,{name:this.editData.name,address:this.editData.address}).pipe(S(t=>(console.error("Error actualizando empresa",t),M(this.company))))),e.length&&O(e).subscribe(t=>{let i=t[t.length-1];this.company=i,this.editData=T({},i),this.selectedFile=void 0,this.previewImage=void 0,this.prepareCO2Years(),this.updateAvailableYears()})}cancel(){this.user&&(this.user.role==="ADMIN"?this.router.navigate(["/admin/companies"]):this.user.role==="COMPANY_ADMIN"?this.router.navigate(["/company"]):this.router.navigate(["/home"]))}static{this.\u0275fac=function(t){return new(t||m)(b(Ce),b(ye),b($),b(J),b(Q))}}static{this.\u0275cmp=P({type:m,selectors:[["app-company-form"]],standalone:!0,features:[j],decls:27,vars:5,consts:[[1,"p-6","rounded-2xl","shadow-md","bg-white","max-w-3xl","mx-auto"],[1,"text-2xl","font-bold","mb-6","text-center"],[1,"flex","flex-col","md:flex-row","gap-4","mb-6"],["appearance","outline",1,"flex-1"],["matInput","","name","name","required","",3,"ngModelChange","ngModel"],["matInput","","name","address",3,"ngModelChange","ngModel"],[1,"flex","justify-end","gap-4","mt-4"],["mat-stroked-button","","color","warn",3,"click"],["mat-raised-button","","color","primary",3,"click"],[1,"my-6"],[4,"ngIf"],[1,"border","p-4","rounded","shadow-sm","text-center"],["appearance","outline"],["name","newYear",3,"ngModelChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],[1,"text-xl","font-bold","mb-4","text-center"],[1,"mb-8","border","p-4","rounded","shadow-sm"],[1,"font-semibold","mb-2"],[1,"flex","justify-end","mb-2"],["mat-stroked-button","","color","primary",3,"click"],["class","flex gap-4 mb-2 justify-center",4,"ngIf"],[1,"flex","gap-4","justify-center","mb-2","items-center"],[1,"donut-wrapper","text-center"],[1,"donut-label"],[1,"donut-large",3,"id"],[1,"donut-wrapper","neto-wrapper","text-center"],[1,"donut-neto","text-4xl","font-bold",3,"ngClass"],[1,"donut-neto-unit"],[1,"donut-neto-info"],["class","mb-6 border p-4 rounded shadow-sm",4,"ngFor","ngForOf"],[1,"flex","gap-4","mb-2","justify-center"],["matInput","","type","number",3,"ngModelChange","ngModel"],[1,"mb-6","border","p-4","rounded","shadow-sm"],[1,"donut-small",3,"id"],[1,"donut-neto","text-xl","font-bold",3,"ngClass"],[3,"value"]],template:function(t,i){t&1&&(a(0,"mat-card",0)(1,"h1",1),r(2,"Editar Compa\xF1\xEDa"),n(),a(3,"div",2)(4,"mat-form-field",3)(5,"mat-label"),r(6,"Nombre"),n(),a(7,"input",4),y("ngModelChange",function(s){return v(i.editData.name,s)||(i.editData.name=s),s}),n()(),a(8,"mat-form-field",3)(9,"mat-label"),r(10,"Direcci\xF3n"),n(),a(11,"input",5),y("ngModelChange",function(s){return v(i.editData.address,s)||(i.editData.address=s),s}),n()()(),a(12,"div",6)(13,"button",7),_("click",function(){return i.cancel()}),r(14,"Cancelar"),n(),a(15,"button",8),_("click",function(){return i.saveCompany()}),r(16,"Guardar empresa"),n()(),w(17,"hr",9),E(18,Ie,30,12,"div",10),a(19,"div",11)(20,"mat-form-field",12)(21,"mat-label"),r(22,"A\xF1o"),n(),a(23,"mat-select",13),y("ngModelChange",function(s){return v(i.selectedYear,s)||(i.selectedYear=s),s}),E(24,Te,2,2,"mat-option",14),n()(),a(25,"button",8),_("click",function(){return i.addNewYear(i.selectedYear)}),r(26,"A\xF1adir a\xF1o"),n()()()),t&2&&(d(7),g("ngModel",i.editData.name),d(4),g("ngModel",i.editData.address),d(7),c("ngIf",i.co2Years==null?null:i.co2Years.length),d(5),g("ngModel",i.selectedYear),d(),c("ngForOf",i.availableYears))},dependencies:[G,L,q,U,z,se,ie,ae,ne,re,oe,Z,X,te,ee,le,me,de,pe,ce,fe,ue,K],encapsulation:2})}}return m})();export{Xe as CompanyFormComponent};
