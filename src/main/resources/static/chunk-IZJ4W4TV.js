import{Bb as m,C as n,Cb as U,Eb as v,Gb as b,_a as h,e as c,f as d,g as C,gb as S,h as u,j as i,p as l,v as g,x as y,z as p}from"./chunk-N25POV3O.js";var a=function(o){return o.ADMIN="ADMIN",o.USER="USER",o.COMPANY_ADMIN="COMPANY_ADMIN",o.COMPANY_USER="COMPANY_USER",o}(a||{}),N=[{value:a.ADMIN,label:"Administrador"},{value:a.USER,label:"Usuario"},{value:a.COMPANY_ADMIN,label:"Administrador de Compa\xF1\xEDa"},{value:a.COMPANY_USER,label:"Usuario de Compa\xF1\xEDa"}];var j=(()=>{class o{constructor(r,e){this.authApi=r,this.router=e,this.userSubject=new c(null),this.user$=this.userSubject.asObservable();let t=localStorage.getItem("forestPlus_user");t&&this.userSubject.next(JSON.parse(t))}isLoggedIn(){return this.userSubject.value!==null}logout(){localStorage.removeItem("forestPlus_token"),localStorage.removeItem("forestPlus_user"),this.userSubject.next(null),this.router.navigate(["/login"])}getUser(){return this.userSubject.value}setUser(r,e){let t;r instanceof Blob?r.text().then(s=>{try{t=JSON.parse(s),this.applyUser(t,e)}catch(f){console.error("\u274C Error al parsear usuario desde Blob:",f)}}):(t=r,this.applyUser(t,e))}applyUser(r,e){this.userSubject.next(r),localStorage.setItem("forestPlus_user",JSON.stringify(r)),e&&localStorage.setItem("forestPlus_token",e)}login(r){return this.authApi.login(r).pipe(g(e=>{if(!e.user)throw new Error("No se recibi\xF3 el usuario en la respuesta del login");return e.user instanceof Blob?d(e.user.text()).pipe(i(t=>JSON.parse(t)),y(t=>this.setUser(t,e.token))):(this.setUser(e.user,e.token),C(e.user))}),l(e=>(console.error("Error login",e),u(()=>e))))}register(r){return this.authApi.register(r).pipe(i(e=>{let t=e;if(!t)throw new Error("No se recibi\xF3 el usuario tras el registro");return this.setUser(t),t}),l(e=>u(()=>e)))}forgotPassword(r){return this.authApi.forgotPassword({email:r}).pipe(l(e=>u(()=>e)))}resetPassword(r,e){if(e)return this.authApi.resetForgotPassword(e,r);let t=localStorage.getItem("forestPlus_token");if(!t)throw new Error("No hay token de usuario logueado");let s=`Bearer ${t}`;return this.authApi.resetPassword(s,r)}verifyEmail(r){return this.authApi.verifyEmail(r).pipe(l(e=>u(()=>e)))}updateCurrentUser(r){let e=localStorage.getItem("forestPlus_token");this.setUser(r,e??void 0)}resendVerification(r){return this.authApi.resendVerification({email:r})}resetForgotPassword(r,e){return this.authApi.resetForgotPassword(r,e)}refreshToken(){let r=localStorage.getItem("forestPlus_refresh_token");return r?this.authApi.refreshToken({refreshToken:r}).pipe(i(e=>{if(!e.user||!e.token)throw new Error("Refresh failed: no token/user received");return this.setUser(e.user,e.token),e.refreshToken&&localStorage.setItem("forestPlus_refresh_token",e.refreshToken),e}),l(e=>(this.logout(),u(()=>e)))):(this.logout(),u(()=>new Error("No refresh token found")))}get currentUserRole(){return this.userSubject.value?.role??null}get currentUserCompanyId(){return this.userSubject.value?.company?.id??null}static{this.\u0275fac=function(e){return new(e||o)(n(U),n(S))}}static{this.\u0275prov=p({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();var D=(()=>{class o{constructor(r,e,t){this.userController=r,this.http=e,this.authService=t,this.user$=this.authService.user$}getUser(){return this.authService.user$}updateCurrentUser(r){this.authService.updateCurrentUser(r)}getCurrentUser(){return this.authService.getUser()}getCurrentUser$(){return this.authService.user$}getUsers(r=0,e=10,t="id,asc",s,f){return this.userController.getUsers(s,f,r,e,t)}getUserById(r){return this.userController.getUserById(r)}updateUser(r,e){return this.userController.updateUser(r,e).pipe(i(t=>(this.getCurrentUser()?.id===t.id&&this.authService.updateCurrentUser(t),t)))}updateUserByAdmin(r,e){return this.userController.updateUserByAdmin(r,e)}registerUserByAdmin(r){return this.userController.registerUserByAdmin(r)}deleteUser(r){return this.userController.deleteUser(r)}isAdminOrCompanyAdmin(){let r=this.getCurrentUser();return!!r&&(r.role===a.ADMIN||r.role===a.COMPANY_ADMIN)}updateUserPicture(r,e){let t=new FormData;return t.append("file",e),this.http.put(`${m.apiBaseUrl}/api/users/${r}/picture`,t).pipe(i(s=>(this.getCurrentUser()?.id===s.id&&this.authService.updateCurrentUser(s),s)))}static{this.\u0275fac=function(e){return new(e||o)(n(b),n(h),n(j))}}static{this.\u0275prov=p({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();var Y=(()=>{class o{constructor(r,e){this.companyController=r,this.http=e,this.companySubject=new c(null);let t=localStorage.getItem("forestPlus_company");t&&this.companySubject.next(JSON.parse(t))}getCompany(){return this.companySubject.asObservable()}getCurrentCompany(){return this.companySubject.value}updateCurrentCompany(r){this.companySubject.next(r),localStorage.setItem("forestPlus_company",JSON.stringify(r))}clearCompany(){this.companySubject.next(null),localStorage.removeItem("forestPlus_company")}getAllCompanies(){return this.companyController.getAllCompanies()}getCompanies(r,e,t){return this.companyController.getAllCompanies()}getCompanyById(r){return this.companyController.getCompanyById(r).pipe(i(e=>(this.updateCurrentCompany(e),e)))}createCompany(r){return this.companyController.createCompany(r).pipe(i(e=>(this.updateCurrentCompany(e),e)))}updateCompany(r,e){let t={name:e.name,address:e.address};return this.companyController.updateCompany(r,t).pipe(i(s=>(this.companySubject.value?.id===s.id&&this.updateCurrentCompany(s),s)))}deleteCompany(r){return this.companyController.deleteCompany(r).pipe(i(e=>(this.companySubject.value?.id===r&&this.clearCompany(),e)))}updateCompanyPicture(r,e){let t=new FormData;return t.append("file",e),this.http.put(`${m.apiBaseUrl}/api/companies/${r}/picture`,t).pipe(i(s=>(this.companySubject.value?.id===s.id&&this.updateCurrentCompany(s),s)))}static{this.\u0275fac=function(e){return new(e||o)(n(v),n(h))}}static{this.\u0275prov=p({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();export{a,N as b,j as c,D as d,Y as e};
