import{a as we,b as Se,c as Fe,d as Ye,e as $,f as Ve,g as Ie,h as Te}from"./chunk-P6GH42AD.js";import{d as oe,e as Me}from"./chunk-IZJ4W4TV.js";import{b as ae}from"./chunk-P4UYLIGP.js";import{$ as v,$b as be,Aa as A,Ba as s,C as U,Ca as q,Da as y,Db as ne,E as L,Ga as w,Ha as S,Ia as F,J as c,Ja as z,Jb as re,K as p,La as k,Ma as H,Mb as se,Na as R,Nb as de,Oa as D,Ob as le,Pb as me,Qb as ce,Rb as pe,Sb as _e,T as G,Ta as J,Tb as ue,U as d,Ua as K,Ub as ge,V as b,Va as Q,Vb as fe,Wb as ve,Xa as X,Xb as Ce,Ya as Z,Yb as xe,Za as ee,Zb as he,_b as ye,ac as Ee,ca as m,d as B,eb as te,g as V,gb as ie,ha as r,ia as n,ja as x,ka as T,la as O,m as W,na as h,p as I,qa as g,sa as l,w as E,z as P}from"./chunk-N25POV3O.js";var Oe=(()=>{class a{constructor(e){this.co2Api=e}getAll(e){return this.co2Api.getAll(e)}save(e,t){return this.co2Api.createOrUpdate(e,t)}delete(e,t){return console.log("dnetro1",e),this.co2Api._delete(e,t)}static{this.\u0275fac=function(t){return new(t||a)(U(ne))}}static{this.\u0275prov=P({token:a,factory:a.\u0275fac,providedIn:"root"})}}return a})();function $e(a,u){if(a&1){let e=h();r(0,"div",41)(1,"div")(2,"label",42),s(3,"Emitido"),n(),r(4,"input",43),F("ngModelChange",function(i){c(e);let o=l(5);return S(o.co2Years[0].editEmissions,i)||(o.co2Years[0].editEmissions=i),p(i)}),n()(),r(5,"div")(6,"label",42),s(7,"Compensado"),n(),r(8,"input",43),F("ngModelChange",function(i){c(e);let o=l(5);return S(o.co2Years[0].editCompensations,i)||(o.co2Years[0].editCompensations=i),p(i)}),n()(),r(9,"button",44),g("click",function(){c(e);let i=l(5);return p(i.saveCO2(i.co2Years[0]))}),s(10," Guardar "),n()()}if(a&2){let e=l(5);d(4),w("ngModel",e.co2Years[0].editEmissions),d(4),w("ngModel",e.co2Years[0].editCompensations)}}function je(a,u){if(a&1){let e=h();T(0),r(1,"button",45),g("click",function(){c(e);let i=l(5);return p(i.toggleEditCO2(i.co2Years[0]))}),s(2," Editar "),n(),O()}}function Be(a,u){if(a&1){let e=h();r(0,"button",46),g("click",function(){c(e);let i=l(5);return p(i.toggleEditCO2(i.co2Years[0]))}),s(1," Cancelar "),n(),r(2,"button",47),g("click",function(){c(e);let i=l(5);return p(i.deleteCO2(i.co2Years[0]))}),s(3," Eliminar "),n()}}function We(a,u){if(a&1){let e=h();r(0,"div",41)(1,"div")(2,"label",42),s(3,"Emitido"),n(),r(4,"input",43),F("ngModelChange",function(i){c(e);let o=l().$implicit;return S(o.editEmissions,i)||(o.editEmissions=i),p(i)}),n()(),r(5,"div")(6,"label",42),s(7,"Compensado"),n(),r(8,"input",43),F("ngModelChange",function(i){c(e);let o=l().$implicit;return S(o.editCompensations,i)||(o.editCompensations=i),p(i)}),n()(),r(9,"button",44),g("click",function(){c(e);let i=l().$implicit,o=l(5);return p(o.saveCO2(i))}),s(10," Guardar "),n()()}if(a&2){let e=l().$implicit;d(4),w("ngModel",e.editEmissions),d(4),w("ngModel",e.editCompensations)}}function Pe(a,u){if(a&1){let e=h();T(0),r(1,"button",45),g("click",function(){c(e);let i=l().$implicit,o=l(5);return p(o.toggleEditCO2(i))}),s(2," Editar "),n(),O()}}function Ue(a,u){if(a&1){let e=h();r(0,"button",46),g("click",function(){c(e);let i=l().$implicit,o=l(5);return p(o.toggleEditCO2(i))}),s(1," Cancelar "),n(),r(2,"button",47),g("click",function(){c(e);let i=l().$implicit,o=l(5);return p(o.deleteCO2(i))}),s(3," Eliminar "),n()}}function Le(a,u){if(a&1&&(r(0,"div",48)(1,"h3",28),s(2),n(),v(3,We,11,2,"div",29),r(4,"div",30)(5,"div",31)(6,"div",32),s(7,"Emitido"),n(),x(8,"canvas",49),n(),r(9,"div",31)(10,"div",32),s(11,"Compensado"),n(),x(12,"canvas",49),n(),r(13,"div",31)(14,"div",50),s(15),k(16,"number"),n(),r(17,"div",51),s(18,"Toneladas de CO\u2082"),n(),r(19,"div",52),s(20),n()()(),r(21,"div",37)(22,"div",38),v(23,Pe,3,0,"ng-container",39)(24,Ue,4,0,"ng-template",null,0,D),n()()()),a&2){let e=u.$implicit,t=A(25),i=l(5);d(2),y("A\xF1o ",e.year,""),d(),m("ngIf",e.editMode),d(5),m("id",e.emitidoRef),d(4),m("id",e.compensadoRef),d(2),m("ngClass",i.getNetColorClass(e.totalEmissions,e.totalCompensations)),d(),y(" ",R(16,9,e.totalEmissions-e.totalCompensations,"1.0-0")," "),d(5),y(" (",i.getCompensatedPercentage(e.totalEmissions,e.totalCompensations),"% compensado) "),d(3),m("ngIf",!e.editMode)("ngIfElse",t)}}function Ge(a,u){if(a&1&&(r(0,"div")(1,"h2",26),s(2,"Emisiones de CO\u2082 por a\xF1o"),n(),r(3,"div",27)(4,"h3",28),s(5),n(),v(6,$e,11,2,"div",29),r(7,"div",30)(8,"div",31)(9,"div",32),s(10,"Emitido"),n(),x(11,"canvas",33),n(),r(12,"div",31)(13,"div",32),s(14,"Compensado"),n(),x(15,"canvas",33),n(),r(16,"div",31)(17,"div",32),s(18,"Valor Neto"),n(),r(19,"div",34),s(20),k(21,"number"),n(),r(22,"div",35),s(23,"Toneladas de CO\u2082"),n(),r(24,"div",36),s(25),n()()(),r(26,"div",37)(27,"div",38),v(28,je,3,0,"ng-container",39)(29,Be,4,0,"ng-template",null,0,D),n()()(),v(31,Le,26,12,"div",40),n()),a&2){let e=A(30),t=l(4);d(5),y("\xDAltimo a\xF1o registrado: ",t.co2Years[0].year,""),d(),m("ngIf",t.co2Years[0].editMode),d(5),m("id",t.co2Years[0].emitidoRef),d(4),m("id",t.co2Years[0].compensadoRef),d(4),m("ngClass",t.getNetColorClass(t.co2Years[0].totalEmissions,t.co2Years[0].totalCompensations)),d(),y(" ",R(21,10,t.co2Years[0].totalEmissions-t.co2Years[0].totalCompensations,"1.0-0")," "),d(5),y(" (Has compensado el ",t.getCompensatedPercentage(t.co2Years[0].totalEmissions,t.co2Years[0].totalCompensations),"%) "),d(3),m("ngIf",!t.co2Years[0].editMode)("ngIfElse",e),d(3),m("ngForOf",t.co2Years.slice(1))}}function qe(a,u){if(a&1&&(r(0,"option",53),s(1),n()),a&2){let e=u.$implicit;m("value",e),d(),q(e)}}function ze(a,u){if(a&1){let e=h();T(0),v(1,Ge,32,13,"div",20),r(2,"div",21)(3,"label",22),s(4,"A\xF1o"),n(),r(5,"select",23),F("ngModelChange",function(i){c(e);let o=l(3);return S(o.selectedYear,i)||(o.selectedYear=i),p(i)}),v(6,qe,2,2,"option",24),n(),x(7,"br"),r(8,"button",25),g("click",function(){c(e);let i=l(3);return p(i.addNewYear(i.selectedYear))}),s(9," A\xF1adir a\xF1o "),n()(),O()}if(a&2){let e=l(3);d(),m("ngIf",e.co2Years==null?null:e.co2Years.length),d(4),w("ngModel",e.selectedYear),d(),m("ngForOf",e.availableYears)}}function He(a,u){if(a&1&&(r(0,"div"),v(1,ze,10,3,"ng-container",20),n()),a&2){let e=u.ngIf;d(),m("ngIf",e.role==="ADMIN")}}function Je(a,u){if(a&1){let e=h();r(0,"div",2)(1,"form",3),g("ngSubmit",function(){c(e);let i=l();return p(i.onSubmitCompany())}),r(2,"h1",4),s(3),n(),r(4,"div",5),x(5,"img",6),r(6,"label",7)(7,"span",8),s(8,"photo_camera"),n(),r(9,"span"),s(10,"Seleccionar imagen"),n(),r(11,"input",9),g("change",function(i){c(e);let o=l();return p(o.onCompanyFileSelected(i))}),n()()(),r(12,"div",10)(13,"div",11)(14,"label",12),s(15,"Nombre"),n(),x(16,"input",13),n(),r(17,"div",11)(18,"label",14),s(19,"Direcci\xF3n"),n(),x(20,"input",15),n()(),r(21,"div",16)(22,"button",17),g("click",function(){c(e);let i=l();return p(i.cancel())}),s(23," Cancelar "),n(),r(24,"button",18),s(25),n()()(),x(26,"hr",19),v(27,He,2,1,"div",20),k(28,"async"),n()}if(a&2){let e=l();d(),m("formGroup",e.companyForm),d(2),y(" ",e.company.id?"Editar Compa\xF1\xEDa":"Nueva Compa\xF1\xEDa"," "),d(2),m("src",e.previewImage||e.company.picture||"assets/logo-white.png",G),d(20),y(" ",e.company.id?"Guardar cambios":"Crear empresa"," "),d(2),m("ngIf",H(28,5,e.currentUser$))}}var pt=(()=>{class a{constructor(e,t,i,o,_,C){this.fb=e,this.companyService=t,this.companyCo2Service=i,this.route=o,this.router=_,this.userService=C,this.company={id:void 0,name:"",address:"",co2:[]},this.co2Years=[],this.chartsMap={},this.availableYears=[],this.currentUser$=this.userService.getCurrentUser$(),this.destroy$=new B,$.register(Ye,Ve,Te,Ie)}ngOnInit(){this.initForm();let e=Number(this.route.snapshot.paramMap.get("id"));e&&this.loadCompany(e),this.userService.getUser().pipe(E(this.destroy$)).subscribe(t=>this.user=t)}ngOnDestroy(){Object.values(this.chartsMap).forEach(e=>e.destroy()),this.destroy$.next(),this.destroy$.complete()}initForm(){this.companyForm=this.fb.group({name:["",le.required],address:[""]})}loadCompany(e){this.companyService.getCompanyById(e).pipe(E(this.destroy$)).subscribe(t=>{this.company=t,this.companyForm.patchValue({name:t.name,address:t.address}),this.previewImage=t.picture,this.prepareCO2Years(),this.updateAvailableYears()})}onCompanyFileSelected(e){let t=e.target.files[0];if(!t)return;this.selectedFile=t;let i=new FileReader;i.onload=()=>this.previewImage=i.result,i.readAsDataURL(t)}onSubmitCompany(){if(this.companyForm.invalid)return;let e=this.companyForm.value,t=[];if(!this.company.id)t.push(this.companyService.createCompany(e).pipe(I(i=>(console.error("Error creando empresa",i),V(null)))));else if(this.selectedFile&&t.push(this.companyService.updateCompanyPicture(this.company.id,this.selectedFile).pipe(I(i=>(console.error("Error actualizando imagen",i),V(this.company))))),(e.name!==this.company.name||e.address!==this.company.address)&&t.push(this.companyService.updateCompany(this.company.id,e).pipe(I(i=>(console.error("Error actualizando empresa",i),V(this.company))))),!t.length)return;W(t).pipe(E(this.destroy$)).subscribe(i=>{let o=i[i.length-1];o&&(this.company=o,this.companyForm.patchValue({name:o.name,address:o.address}),this.previewImage=o.picture,this.selectedFile=void 0,this.prepareCO2Years(),this.updateAvailableYears(),this.user&&(this.user.role==="ADMIN"?this.router.navigate(["/admin/companies"]):this.user.role==="COMPANY_ADMIN"?this.router.navigate(["/company"]):this.router.navigate(["/home"])))})}cancel(){this.user&&(this.user.role==="ADMIN"?this.router.navigate(["/admin/companies"]):this.user.role==="COMPANY_ADMIN"?this.router.navigate(["/company"]):this.router.navigate(["/home"]))}prepareCO2Years(){if(!this.company?.co2?.length){this.co2Years=[];return}let e=[...this.company.co2].filter(t=>t.year!==void 0).sort((t,i)=>i.year-t.year);this.co2Years=e.map(t=>({id:t.id,year:t.year,totalEmissions:t.totalEmissions||0,totalCompensations:t.totalCompensations||0,net:(t.totalEmissions||0)-(t.totalCompensations||0),emitidoRef:`emitido-${t.year}`,compensadoRef:`compensado-${t.year}`,netoRef:`neto-${t.year}`,editMode:!1,editEmissions:t.totalEmissions||0,editCompensations:t.totalCompensations||0})),setTimeout(()=>this.renderCO2Charts(),0)}toggleEditCO2(e){console.log("toggleEditCO2",e),e.editMode?e._backup&&(e.totalEmissions=e._backup.emissions,e.totalCompensations=e._backup.compensations):e._backup={emissions:e.totalEmissions,compensations:e.totalCompensations},e.editMode=!e.editMode,setTimeout(()=>this.renderCO2Charts(),0)}deleteCO2(e){console.log("deleteCO2",this.company.id,e.id),!(!this.company?.id||!e.id)&&this.companyCo2Service.delete(this.company.id,e.id).subscribe({next:()=>{this.co2Years=this.co2Years.filter(t=>t.id!==e.id),this.updateAvailableYears()},error:t=>{console.error("Error al eliminar CO2",t)}})}saveCO2(e){if(!this.company?.id)return;let t=e.editEmissions??0,i=e.editCompensations??0;e.net=t-i;let o={year:e.year,totalEmissions:t,totalCompensations:i};this.companyCo2Service.save(this.company.id,o).pipe(E(this.destroy$)).subscribe({next:_=>{this.loadCompany(this.company.id)},error:_=>console.error("Error guardando CO\u2082",_)})}addNewYear(e){if(!e||!this.company?.id)return;let t={year:e,totalEmissions:0,totalCompensations:0,net:0,emitidoRef:`emitido-${e}`,compensadoRef:`compensado-${e}`,netoRef:`neto-${e}`,editMode:!0,editEmissions:0,editCompensations:0},i={year:e,totalEmissions:0,totalCompensations:0};this.companyCo2Service.save(this.company.id,i).pipe(E(this.destroy$)).subscribe({next:o=>{t.id=o.id,this.co2Years.push(t),this.co2Years.sort((_,C)=>C.year-_.year),this.selectedYear=void 0,this.updateAvailableYears(),setTimeout(()=>this.renderCO2Charts(),0)},error:o=>console.error("Error guardando nuevo a\xF1o CO\u2082",o)})}createDonutChart(e,t,i,o){let _=e.getContext("2d");if(!_)return;this.chartsMap[e.id]&&this.chartsMap[e.id].destroy();let C={id:"centerText",beforeDraw:Ae=>{let{ctx:f,width:j,height:Y}=Ae;f&&(f.save(),f.font=`${Y/100*20}px sans-serif`,f.fillStyle="#333",f.textBaseline="middle",f.fillText(`${t}`,j/2-f.measureText(`${t}`).width/2,Y/2-10),f.font=`${Y/100*8}px sans-serif`,f.fillStyle="#666",f.fillText("Toneladas de CO\u2082",j/2-f.measureText("Toneladas de CO\u2082").width/2,Y/2+15),f.restore())}},N=o>0?o:1,M=t/N*100,ke={datasets:[{data:[M,100-M],backgroundColor:[i,"#e0e0e0"],cutout:"75%",borderWidth:0}]},Ne={responsive:!0,animation:{animateRotate:!0,animateScale:!0,duration:1e3},plugins:{legend:{display:!1},tooltip:{enabled:!1}}};this.chartsMap[e.id]=new $(_,{type:"doughnut",data:ke,options:Ne,plugins:[C]})}renderCO2Charts(){Object.values(this.chartsMap).forEach(t=>t.destroy()),this.chartsMap={};let e=["emitidoRef","compensadoRef","netoRef"];this.co2Years.forEach((t,i)=>{let o=i===0?200:80;e.forEach(_=>{let C=document.getElementById(t[_]);if(!C)return;C.width=o,C.height=o;let N=_==="emitidoRef"?t.totalEmissions:_==="compensadoRef"?t.totalCompensations:t.net,M=_==="emitidoRef"?"#fc4d03ff":_==="compensadoRef"?"#89de8cff":"#2c80c5cf";this.createDonutChart(C,N,M,t.totalEmissions||1)})})}updateAvailableYears(){let e=new Date().getFullYear(),t=this.co2Years.map(i=>i.year);this.availableYears=[];for(let i=2020;i<=e;i++)t.includes(i)||this.availableYears.push(i);this.availableYears.sort((i,o)=>o-i)}getNetColorClass(e,t){let i=e-t,o=e>0?i/e:1;return o<.5?"net-yellow":o<=1?"net-red":"net-green"}getCompensatedPercentage(e,t){return e?(t/e*100).toFixed(0):"0"}static{this.\u0275fac=function(t){return new(t||a)(b(ye),b(Me),b(Oe),b(te),b(ie),b(oe))}}static{this.\u0275cmp=L({type:a,selectors:[["app-company-form"]],standalone:!0,features:[z],decls:1,vars:1,consts:[["editModeButtons",""],["class","w-full max-w-full mx-auto bg-white p-6 rounded-2xl shadow-lg",4,"ngIf"],[1,"w-full","max-w-full","mx-auto","bg-white","p-6","rounded-2xl","shadow-lg"],[3,"ngSubmit","formGroup"],[1,"text-2xl","font-bold","mb-6","text-center"],[1,"md:col-span-2","flex","flex-col","items-center","mb-6"],["alt","Logo de la compa\xF1\xEDa",1,"w-24","h-24","rounded-full","shadow-lg","mb-2","object-cover",3,"src"],[1,"cursor-pointer","bg-gray-200","hover:bg-gray-300","p-2","rounded-full","flex","items-center","gap-2"],[1,"material-icons"],["type","file","accept","image/*","hidden","",3,"change"],[1,"flex","flex-col","md:flex-row","gap-4","mb-6"],[1,"flex-1"],["for","name",1,"block","text-gray-700","font-medium","mb-1"],["id","name","type","text","formControlName","name","required","","placeholder","Nombre de la compa\xF1\xEDa",1,"w-full","rounded-xl","border","border-gray-300","px-4","py-2","shadow-sm","focus:outline-none","focus:ring-2","focus:ring-green-500","focus:border-transparent","transition"],["for","address",1,"block","text-gray-700","font-medium","mb-1"],["id","address","type","text","formControlName","address","placeholder","Direcci\xF3n",1,"w-full","rounded-xl","border","border-gray-300","px-4","py-2","shadow-sm","focus:outline-none","focus:ring-2","focus:ring-green-500","focus:border-transparent","transition"],[1,"flex","justify-end","gap-4","mt-6"],["type","button",1,"flex-1","bg-gray-300","text-gray-700","py-3","rounded-xl","hover:bg-gray-400","transition",3,"click"],["type","submit",1,"flex-1","bg-green-600","text-white","py-3","rounded-xl","hover:bg-green-700","disabled:opacity-50","transition"],[1,"my-6"],[4,"ngIf"],[1,"border","p-4","rounded-xl","shadow-sm","text-center","mt-6","bg-gray-50"],["for","newYear",1,"block","text-gray-700","font-medium","mb-2"],["id","newYear","name","newYear",1,"w-32","rounded-xl","border","border-gray-300","px-3","py-2","shadow-sm","focus:outline-none","focus:ring-2","focus:ring-green-500","focus:border-transparent","transition","mb-2",3,"ngModelChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],[1,"w-32","bg-green-600","text-white","py-2","rounded-xl","hover:bg-green-700","transition","mt-2",3,"click"],[1,"text-xl","font-bold","mb-4","text-center"],[1,"mb-8","border","p-4","rounded-xl","shadow-sm","bg-gray-50"],[1,"font-semibold","mb-2"],["class","flex flex-wrap gap-4 mb-4 justify-center",4,"ngIf"],[1,"flex","flex-wrap","gap-4","justify-center","items-center"],[1,"text-center"],[1,"font-medium"],[1,"donut-large",3,"id"],[1,"text-4xl","font-bold",3,"ngClass"],[1,"text-gray-600","text-sm"],[1,"text-xs","text-gray-500","mt-1"],[1,"mt-5","flex","justify-end","mb-2"],[1,"flex","justify-center","mt-4","gap-4","w-full"],[4,"ngIf","ngIfElse"],["class","mb-6 border p-4 rounded-xl shadow-sm bg-gray-50",4,"ngFor","ngForOf"],[1,"flex","flex-wrap","gap-4","mb-4","justify-center"],[1,"block","text-gray-700","font-medium","mb-1"],["type","number",1,"w-32","rounded-xl","border","border-gray-300","px-3","py-1","shadow-sm","focus:outline-none","focus:ring-2","focus:ring-green-500","focus:border-transparent","transition",3,"ngModelChange","ngModel"],[1,"px-4","py-2","rounded-xl","bg-blue-600","text-white","hover:bg-blue-700","transition",3,"click"],[1,"bg-green-600","text-white","py-3","px-6","rounded-xl","hover:bg-green-700","transition","w-1/2",3,"click"],[1,"bg-gray-300","text-gray-700","py-3","px-6","rounded-xl","hover:bg-gray-400","transition","flex-1",3,"click"],[1,"bg-red-600","text-white","py-3","px-6","rounded-xl","hover:bg-red-700","transition","flex-1",3,"click"],[1,"mb-6","border","p-4","rounded-xl","shadow-sm","bg-gray-50"],[1,"donut-small",3,"id"],[1,"font-semibold","text-lg",3,"ngClass"],[1,"text-sm","text-gray-600"],[1,"text-xs","text-gray-500"],[3,"value"]],template:function(t,i){t&1&&v(0,Je,29,7,"div",1),t&2&&m("ngIf",i.company)},dependencies:[ee,J,K,Q,X,Z,be,_e,Ce,xe,de,ue,ve,me,ce,he,pe,Ee,ge,fe,ae,se,we,Se,Fe,re],encapsulation:2})}}return a})();export{pt as CompanyFormComponent};
