import{c as L,d as D}from"./chunk-WGHYFE3A.js";import{a as c,b as U,c as O,d as T,e as K}from"./chunk-IZJ4W4TV.js";import{a as J}from"./chunk-LF5WZ7KE.js";import{$ as h,Ba as d,Ca as m,Da as S,E as b,Ja as A,Jb as P,La as s,Ma as l,Nb as V,Ob as E,Pb as Y,Qb as k,Sb as j,T as F,U as r,Ua as R,Ub as q,V as v,Va as M,Vb as G,Wb as Q,Xb as z,Yb as H,Za as N,_b as $,ac as W,ca as p,eb as w,gb as B,ha as a,ia as o,ja as I,qa as y,sa as C}from"./chunk-N25POV3O.js";function X(i,u){i&1&&(a(0,"div",24),d(1),s(2,"translate"),o()),i&2&&(r(),m(l(2,1,"USER.FIELD_REQUIRED")))}function Z(i,u){i&1&&(a(0,"div",24),d(1),s(2,"translate"),o()),i&2&&(r(),m(l(2,1,"USER.FIELD_REQUIRED")))}function ee(i,u){i&1&&(a(0,"div"),d(1),s(2,"translate"),o()),i&2&&(r(),m(l(2,1,"USER.FIELD_REQUIRED")))}function te(i,u){i&1&&(a(0,"div"),d(1),s(2,"translate"),o()),i&2&&(r(),S("",l(2,1,"USER.INVALID_EMAIL")," "))}function ie(i,u){if(i&1&&(a(0,"div",24),h(1,ee,3,3,"div",18)(2,te,3,3,"div",18),o()),i&2){let e,t,n=C();r(),p("ngIf",(e=n.userForm.get("email"))==null?null:e.hasError("required")),r(),p("ngIf",(t=n.userForm.get("email"))==null?null:t.hasError("email"))}}function re(i,u){if(i&1&&(a(0,"option",25),d(1),o()),i&2){let e=u.$implicit;p("value",e.value),r(),m(e.label)}}function ne(i,u){i&1&&(a(0,"div",24),d(1),s(2,"translate"),o()),i&2&&(r(),m(l(2,1,"USER.FIELD_REQUIRED")))}function oe(i,u){if(i&1&&(a(0,"option",25),d(1),o()),i&2){let e=u.$implicit;p("value",e.id),r(),m(e.name)}}function ae(i,u){i&1&&(a(0,"div",24),d(1),s(2,"translate"),o()),i&2&&(r(),m(l(2,1,"USER.FIELD_REQUIRED")))}function se(i,u){if(i&1&&(a(0,"div")(1,"label",9),d(2),s(3,"translate"),o(),a(4,"select",26)(5,"option",16),d(6),s(7,"translate"),o(),h(8,oe,2,2,"option",17),o(),h(9,ae,3,3,"div",11),o()),i&2){let e,t=C();r(2),m(l(3,4,"USER.COMPANY_LABEL")),r(4),m(l(7,6,"USER.SELECT_COMPANY")),r(2),p("ngForOf",t.getSelectableCompanies()),r(),p("ngIf",((e=t.userForm.get("companyId"))==null?null:e.invalid)&&((e=t.userForm.get("companyId"))==null?null:e.touched))}}function le(i,u){i&1&&(a(0,"div",27),d(1),s(2,"translate"),o()),i&2&&(r(),S(" ",l(2,1,"USER.SUCCESS_MSG")," "))}function de(i,u){if(i&1&&(a(0,"div",28),d(1),o()),i&2){let e=C();r(),S(" ",e.registerError," ")}}var Ce=(()=>{class i{constructor(e,t,n,f,g,_,x){this.fb=e,this.userService=t,this.authService=n,this.companyService=f,this.router=g,this.snackBar=_,this.route=x,this.hidePassword=!0,this.roles=U,this.companies=[],this.registerSuccess=!1,this.registerError="",this.isEditMode=!1,this.isSelfEdit=!1,this.RolesEnum=c,this.isCompanyAdmin=!1,this.isAdmin=!1,this.showCompanySelector=!1}ngOnInit(){if(this.currentUser=this.authService.getUser()??void 0,this.isCompanyAdmin=this.currentUser?.role===c.COMPANY_ADMIN,this.isAdmin=this.currentUser?.role===c.ADMIN,this.showCompanySelector=!1,this.userForm=this.fb.group({name:["",E.required],surname:["",E.required],secondSurname:[""],email:["",[E.required,E.email]],password:["",[E.minLength(6)]],role:[null,E.required],companyId:[""]}),this.configureAvailableRoles(),this.isAdmin||this.isCompanyAdmin)this.route.paramMap.subscribe(e=>{let t=e.get("id");t&&(this.isEditMode=!0,this.userId=+t,this.loadUser(this.userId))}),this.isCompanyAdmin?(this.showCompanySelector=!0,this.companyService.getAllCompanies().subscribe({next:e=>{this.companies=e.filter(n=>n.users?.some(f=>f.role===c.COMPANY_ADMIN));let t=this.currentUser?.company?.id;t&&this.userForm.patchValue({companyId:t})},error:e=>console.error("Error cargando compa\xF1\xEDas",e)})):this.loadCompanies();else{this.isEditMode=!0,this.userId=this.currentUser?.id??0;let e=this.userService.getCurrentUser();e&&(this.userForm.patchValue({name:e.name,surname:e.surname,secondSurname:e.secondSurname,email:e.email,role:e.role,companyId:e.company?.id??"",password:""}),this.isSelfEdit=!0,this.userForm.get("role")?.disable(),this.userForm.get("companyId")?.disable(),this.userForm.get("password")?.disable())}this.userForm.get("role")?.valueChanges.subscribe(e=>{let t=this.userForm.get("companyId");e===c.COMPANY_ADMIN||e===c.COMPANY_USER?(this.showCompanySelector=!0,t?.setValidators([E.required]),t?.enable()):(this.showCompanySelector=!1,t?.clearValidators(),t?.setValue(""),this.isCompanyAdmin||t?.disable()),t?.updateValueAndValidity()})}configureAvailableRoles(){this.currentUser&&(this.currentUser.role===c.ADMIN?this.roles=U:this.currentUser.role===c.COMPANY_ADMIN&&(this.roles=U.filter(e=>e.value===c.COMPANY_ADMIN||e.value===c.COMPANY_USER)))}loadCompanies(){this.companyService.getAllCompanies().subscribe({next:e=>{this.companies=e},error:e=>console.error("Error cargando compa\xF1\xEDas",e)})}loadUser(e){this.userService.getUserById(e).subscribe({next:t=>{this.user=t,this.previewImage=t.picture,this.isSelfEdit=this.currentUser?.id===this.userId,this.userForm.patchValue({name:t.name,surname:t.surname,secondSurname:t.secondSurname,email:t.email,role:t.role,companyId:t.company?.id??""}),this.isSelfEdit?(this.userForm.get("role")?.disable(),this.userForm.get("companyId")?.disable(),this.userForm.get("password")?.disable()):this.userForm.get("email")?.disable()},error:t=>console.error("\u274C Error al cargar usuario",t)})}onFileSelected(e){let t=e.target.files[0];if(t){this.selectedFile=t;let n=new FileReader;n.onload=()=>this.previewImage=n.result,n.readAsDataURL(t)}}onSubmit(){if(this.userForm.invalid)return;let e=this.userForm.getRawValue();this.isCompanyAdmin&&(e.companyId=this.currentUser?.company?.id??void 0);let t;this.selectedFile&&this.isEditMode?t=this.userService.updateUserPicture(this.userId,this.selectedFile):this.isEditMode?t=this.isSelfEdit?this.userService.updateUser(this.userId,e):this.userService.updateUserByAdmin(this.userId,e):t=this.userService.registerUserByAdmin(e),t.subscribe({next:n=>{this.finalizeUpdate(n)},error:n=>{this.registerError=n.error?.message||"Error al guardar usuario",this.registerSuccess=!1,console.error(n)}})}finalizeUpdate(e){this.user=e,this.previewImage=e.picture,this.selectedFile=void 0,this.snackBar.open("\u2705 Usuario actualizado con \xE9xito","Cerrar",{duration:3e3}),this.isSelfEdit?(this.authService.updateCurrentUser(e),this.router.navigate(["/profile"])):this.router.navigate(["/admin/users"])}onCancel(){this.isSelfEdit?this.router.navigate(["/profile"]):this.router.navigate(["/admin/users"])}showCompanySelectorDynamic(){let e=this.authService.currentUserRole,t=this.userForm.get("role")?.value;return t===c.COMPANY_ADMIN||t===c.COMPANY_USER}isCompanyAdminEditing(){return this.authService.currentUserRole===c.COMPANY_ADMIN}getSelectableCompanies(){return this.authService.currentUserRole===c.ADMIN?this.companies:this.companies.filter(e=>e.id===this.authService.currentUserCompanyId)}static{this.\u0275fac=function(t){return new(t||i)(v($),v(T),v(O),v(K),v(B),v(J),v(w))}}static{this.\u0275cmp=b({type:i,selectors:[["app-user-form"]],standalone:!0,features:[A],decls:62,vars:53,consts:[[1,"w-full","max-w-full","mx-auto","bg-white","p-6","rounded-2xl","shadow-lg"],[1,"text-2xl","font-bold","text-green-700","text-center","mb-6"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-4",3,"ngSubmit","formGroup"],[1,"md:col-span-2","flex","flex-col","items-center","mb-4"],["alt","Avatar",1,"w-24","h-24","rounded-full","shadow-lg","mb-2","object-cover",3,"src"],[1,"cursor-pointer","bg-gray-200","hover:bg-gray-300","p-2","rounded-full","flex","items-center","gap-2"],[1,"material-icons"],["type","file","accept","image/*","hidden","",3,"change"],[1,"md:col-span-2"],[1,"block","text-gray-700","font-medium","mb-1"],["type","text","formControlName","name",1,"w-full","rounded-xl","border","border-gray-300","px-4","py-2","shadow-sm","focus:outline-none","focus:ring-2","focus:ring-green-500","focus:border-transparent","transition",3,"placeholder"],["class","text-red-500 text-sm mt-1",4,"ngIf"],["type","text","formControlName","surname",1,"w-full","rounded-xl","border","border-gray-300","px-4","py-2","shadow-sm","focus:outline-none","focus:ring-2","focus:ring-green-500","focus:border-transparent","transition",3,"placeholder"],["type","text","formControlName","secondSurname",1,"w-full","rounded-xl","border","border-gray-300","px-4","py-2","shadow-sm","focus:outline-none","focus:ring-2","focus:ring-green-500","focus:border-transparent","transition",3,"placeholder"],["type","email","formControlName","email",1,"w-full","rounded-xl","border","border-gray-300","px-4","py-2","shadow-sm","focus:outline-none","focus:ring-2","focus:ring-green-500","focus:border-transparent","transition",3,"placeholder"],["formControlName","role",1,"w-full","rounded-xl","border","border-gray-300","px-4","py-2","shadow-sm","focus:outline-none","focus:ring-2","focus:ring-green-500","focus:border-transparent","transition"],["value",""],[3,"value",4,"ngFor","ngForOf"],[4,"ngIf"],[1,"md:col-span-2","mt-4","flex","gap-4"],["type","button",1,"flex-1","bg-gray-300","text-gray-700","py-3","rounded-xl","hover:bg-gray-400","transition",3,"click"],["type","submit",1,"flex-1","bg-green-600","text-white","py-3","rounded-xl","hover:bg-green-700","disabled:opacity-50","transition"],["class","text-center text-green-600 font-semibold text-lg mt-4",4,"ngIf"],["class","text-center text-red-500 mt-4",4,"ngIf"],[1,"text-red-500","text-sm","mt-1"],[3,"value"],["formControlName","companyId",1,"w-full","rounded-xl","border","border-gray-300","px-4","py-2","shadow-sm","focus:outline-none","focus:ring-2","focus:ring-green-500","focus:border-transparent","disabled:bg-gray-100","disabled:cursor-not-allowed","transition"],[1,"text-center","text-green-600","font-semibold","text-lg","mt-4"],[1,"text-center","text-red-500","mt-4"]],template:function(t,n){if(t&1&&(a(0,"div",0)(1,"h2",1),d(2),s(3,"translate"),s(4,"translate"),o(),a(5,"form",2),y("ngSubmit",function(){return n.onSubmit()}),a(6,"div",3),I(7,"img",4),a(8,"label",5)(9,"span",6),d(10,"photo_camera"),o(),a(11,"span"),d(12,"Seleccionar foto"),o(),a(13,"input",7),y("change",function(g){return n.onFileSelected(g)}),o()()(),a(14,"div",8)(15,"label",9),d(16),s(17,"translate"),o(),I(18,"input",10),s(19,"translate"),h(20,X,3,3,"div",11),o(),a(21,"div")(22,"label",9),d(23),s(24,"translate"),o(),I(25,"input",12),s(26,"translate"),h(27,Z,3,3,"div",11),o(),a(28,"div")(29,"label",9),d(30),s(31,"translate"),o(),I(32,"input",13),s(33,"translate"),o(),a(34,"div",8)(35,"label",9),d(36),s(37,"translate"),o(),I(38,"input",14),s(39,"translate"),h(40,ie,3,2,"div",11),o(),a(41,"div")(42,"label",9),d(43),s(44,"translate"),o(),a(45,"select",15)(46,"option",16),d(47),s(48,"translate"),o(),h(49,re,2,2,"option",17),o(),h(50,ne,3,3,"div",11),o(),h(51,se,10,8,"div",18),a(52,"div",19)(53,"button",20),y("click",function(){return n.onCancel()}),d(54),s(55,"translate"),o(),a(56,"button",21),d(57),s(58,"translate"),s(59,"translate"),o()()(),h(60,le,3,3,"div",22)(61,de,2,1,"div",23),o()),t&2){let f,g,_,x;r(2),S(" ",n.isEditMode?l(3,23,"USER.EDIT_TITLE"):l(4,25,"USER.NEW_TITLE")," "),r(3),p("formGroup",n.userForm),r(2),p("src",n.previewImage||"assets/logo-white.png",F),r(9),m(l(17,27,"USER.NAME_LABEL")),r(2),p("placeholder",l(19,29,"USER.NAME_PLACEHOLDER")),r(2),p("ngIf",((f=n.userForm.get("name"))==null?null:f.invalid)&&((f=n.userForm.get("name"))==null?null:f.touched)),r(3),m(l(24,31,"USER.SURNAME_LABEL")),r(2),p("placeholder",l(26,33,"USER.SURNAME_PLACEHOLDER")),r(2),p("ngIf",((g=n.userForm.get("surname"))==null?null:g.invalid)&&((g=n.userForm.get("surname"))==null?null:g.touched)),r(3),m(l(31,35,"USER.SECOND_SURNAME_LABEL")),r(2),p("placeholder",l(33,37,"USER.SECOND_SURNAME_PLACEHOLDER")),r(4),m(l(37,39,"USER.EMAIL_LABEL")),r(2),p("placeholder",l(39,41,"USER.EMAIL_PLACEHOLDER")),r(2),p("ngIf",((_=n.userForm.get("email"))==null?null:_.invalid)&&((_=n.userForm.get("email"))==null?null:_.touched)),r(3),m(l(44,43,"USER.ROLE_LABEL")),r(4),m(l(48,45,"USER.SELECT_ROLE")),r(2),p("ngForOf",n.roles),r(),p("ngIf",((x=n.userForm.get("role"))==null?null:x.invalid)&&((x=n.userForm.get("role"))==null?null:x.touched)),r(),p("ngIf",n.showCompanySelectorDynamic()),r(3),S(" ",l(55,47,"USER.CANCEL_BUTTON")," "),r(3),S(" ",n.isEditMode?l(58,49,"USER.EDIT_BUTTON"):l(59,51,"USER.CREATE_BUTTON")," "),r(3),p("ngIf",n.registerSuccess),r(),p("ngIf",n.registerError)}},dependencies:[N,R,M,W,j,z,H,V,Q,Y,k,q,G,D,L,P],styles:["[_nghost-%COMP%]{display:block;min-height:calc(100vh - 4rem);padding-top:2rem;background-color:#f3f4f6}input[_ngcontent-%COMP%], select[_ngcontent-%COMP%]{transition:border-color .2s}"]})}}return i})();export{Ce as UserFormComponent};
