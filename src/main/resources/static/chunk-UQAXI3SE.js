import{b as pe,c as de,d as ke,e as X,f as Ue,g as je,h as $e}from"./chunk-TADWYEQM.js";import{a as We}from"./chunk-C6ILT3R4.js";import{a as Le}from"./chunk-UEOBNSGU.js";import{c as me,d as _e}from"./chunk-EB46IJZC.js";import{a as Ye,b as Re,d as Be}from"./chunk-36SQWYGU.js";import{a as Pe,b as Ve,c as De}from"./chunk-GYPK2KXW.js";import{a as J}from"./chunk-RQSOZTF4.js";import{b as fe}from"./chunk-AAZTCM4C.js";import{a as xe,b as Ce,d as ve,e as ye,g as he,h as Ee,i as be,k as Te,l as Me,m as Se,n as Ie,o as Oe,q as we,r as Ae,s as Ne,t as Fe}from"./chunk-K7O3QZSU.js";import{b as ge}from"./chunk-HUHLCFM3.js";import{Aa as U,C as ne,Cb as z,Db as H,E as D,Fa as O,Ga as l,Ha as _,Ia as g,J as f,K as x,La as w,Ma as A,Na as N,Pa as j,Ra as Q,Ta as p,U as oe,Ua as d,V as o,Va as R,W as h,Wa as F,da as C,eb as re,f as ee,fb as $,fc as ce,ga as m,gb as W,i as P,ib as G,kb as ae,lb as q,m as te,ma as a,na as r,oa as T,p as V,pa as L,pc as ue,qa as k,sa as E,sb as se,ub as le,v as I,va as v,xa as c,z as ie}from"./chunk-4KXJWRUC.js";function tt(n,u){n&1&&T(0,"app-loading-spinner")}function it(n,u){if(n&1){let e=E();a(0,"li",9)(1,"div")(2,"span",10),l(3),r(),l(4," - "),a(5,"span",11),l(6),r()(),a(7,"button",12),v("click",function(){let i=f(e).$implicit,s=c(3);return x(s.unassignTree(i.id))}),l(8),p(9,"translate"),r()()}if(n&2){let e=u.$implicit;o(3),g("Terreno: ",e.landName,""),o(3),_(e.treeTypeName),o(2),g(" ",d(9,3,"ASSIGN_TREES.UNASSIGN")," ")}}function nt(n,u){if(n&1&&(a(0,"ul"),C(1,it,10,5,"li",8),r()),n&2){let e=c(2);o(),m("ngForOf",e.trees)}}function ot(n,u){n&1&&(a(0,"p",13),l(1),p(2,"translate"),r()),n&2&&(o(),_(d(2,1,"ASSIGN_TREES.NO_TREES")))}function rt(n,u){if(n&1){let e=E();a(0,"div",3)(1,"h2",4),l(2),r(),C(3,nt,2,1,"ul",5)(4,ot,3,3,"ng-template",null,0,F),a(6,"div",6)(7,"button",7),v("click",function(){f(e);let i=c();return x(i.close())}),l(8),p(9,"translate"),r()()()}if(n&2){let e=O(5),t=c();o(2),g(" ",t.treeTypeName," "),o(),m("ngIf",t.trees==null?null:t.trees.length)("ngIfElse",e),o(5),g(" ",d(9,4,"COMMON.CANCEL")," ")}}var qe=(()=>{class n{constructor(e,t,i,s){this.data=e,this.dialogRef=t,this.treeService=i,this.loadingService=s,this.treeTypeName="",this.trees=[],this.target="company",this.treeTypeName=e.treeTypeName||"",this.target=e.target||"company",this.companyId=e.companyId,this.treeTypeId=e.treeTypeId}ngOnInit(){this.companyId&&this.treeTypeId!==void 0&&(this.loadingService.show(),this.treeService.getTreesByOwnerAndType(this.treeTypeId,void 0,this.companyId).subscribe({next:e=>this.trees=e,error:e=>console.error("Error cargando \xE1rboles del tipo",e),complete:()=>this.loadingService.hide()}))}unassignTree(e){let t;this.target==="company"?t=this.treeService.unassignTreeFromCompany(e):t=this.treeService.unassignTreeFromUser(e),t.subscribe({next:()=>{this.trees=this.trees.filter(i=>i.id!==e)},error:i=>console.error("\u274C Error al desasignar \xE1rbol",i)})}close(){this.dialogRef.close({updated:!0})}static{this.\u0275fac=function(t){return new(t||n)(h(Ve),h(Pe),h(J),h(pe))}}static{this.\u0275cmp=D({type:n,selectors:[["app-unassign-trees-modal"]],standalone:!0,features:[j],decls:4,vars:6,consts:[["noTrees",""],[4,"ngIf"],["class","p-6 w-full max-w-md bg-white rounded-2xl shadow-lg",4,"ngIf"],[1,"p-6","w-full","max-w-md","bg-white","rounded-2xl","shadow-lg"],[1,"text-2xl","font-bold","text-green-700","mb-6","text-center"],[4,"ngIf","ngIfElse"],[1,"flex","justify-end","mt-6"],["type","button",1,"px-4","py-2","rounded-lg","bg-gray-200","text-gray-700","hover:bg-gray-300","transition",3,"click"],["class","flex justify-between items-center border-b py-2",4,"ngFor","ngForOf"],[1,"flex","justify-between","items-center","border-b","py-2"],[1,"text-sm","text-gray-500"],[1,"font-semibold"],["type","button",1,"bg-red-200","text-red-800","px-3","py-1","rounded-full","hover:bg-red-300","transition","text-sm",3,"click"],[1,"text-gray-500","italic"]],template:function(t,i){t&1&&(C(0,tt,1,0,"app-loading-spinner",1),p(1,"async"),C(2,rt,10,6,"div",2),p(3,"async")),t&2&&(m("ngIf",d(1,2,i.loadingService.loading$)),o(2),m("ngIf",!d(3,4,i.loadingService.loading$)))},dependencies:[q,$,W,G,H,z,de],encapsulation:2})}}return n})();var ze=(()=>{class n{constructor(e){this.co2Api=e}getAll(e){return this.co2Api.getCompanyCO2YearlyList(e)}save(e,t){return this.co2Api.createOrUpdateCompanyCO2Yearly(e,t)}delete(e,t){return this.co2Api.deleteCompanyCO2Yearly(e,t)}static{this.\u0275fac=function(t){return new(t||n)(ne(ce))}}static{this.\u0275prov=ie({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();var He=n=>({percentage:n});function st(n,u){if(n&1){let e=E();a(0,"button",27),v("click",function(){f(e);let i=c(2);return x(i.openAssignTreesModal(i.company.id))}),l(1),p(2,"translate"),r()}n&2&&(o(),g(" ",d(2,1,"ASSIGN_TREES.ASSIGN_PLANTED_TREES")," "))}function lt(n,u){if(n&1){let e=E();a(0,"button",33),v("click",function(){f(e);let i=c().$implicit,s=c(3);return x(s.openUnassignTreesModal(i))}),l(1),p(2,"translate"),r()}n&2&&(o(),g(" ",d(2,1,"ASSIGN_TREES.UNASSIGN")," "))}function pt(n,u){if(n&1&&(a(0,"li",29)(1,"div")(2,"span",30),l(3),r(),a(4,"span",31),l(5),r()(),C(6,lt,3,3,"button",32),r()),n&2){let e=u.$implicit,t=c(3);o(3),_(e.treeTypeName),o(2),g("",e.quantity||1," \xE1rboles"),o(),m("ngIf",t.isAdmin)}}function dt(n,u){if(n&1&&(a(0,"ul"),C(1,pt,7,3,"li",28),r()),n&2){let e=c(2);o(),m("ngForOf",e.companyTrees)}}function ct(n,u){n&1&&(a(0,"p",34),l(1),p(2,"translate"),r()),n&2&&(o(),_(d(2,1,"COMPANY.NO_TREES_PLANTED")))}function mt(n,u){if(n&1){let e=E();a(0,"div",52)(1,"div")(2,"label",53),l(3),p(4,"translate"),r(),a(5,"input",54),N("ngModelChange",function(i){f(e);let s=c(5);return A(s.co2Years[0].editEmissions,i)||(s.co2Years[0].editEmissions=i),x(i)}),r()(),a(6,"div")(7,"label",53),l(8),p(9,"translate"),r(),a(10,"input",54),N("ngModelChange",function(i){f(e);let s=c(5);return A(s.co2Years[0].editCompensations,i)||(s.co2Years[0].editCompensations=i),x(i)}),r()(),a(11,"button",55),v("click",function(){f(e);let i=c(5);return x(i.saveCO2(i.co2Years[0]))}),l(12),p(13,"translate"),r()()}if(n&2){let e=c(5);o(3),_(d(4,5,"COMPANY_FORM.ISSUED_LABEL")),o(2),w("ngModel",e.co2Years[0].editEmissions),o(3),_(d(9,7,"COMPANY_FORM.COMPENSATED_LABEL")),o(2),w("ngModel",e.co2Years[0].editCompensations),o(2),g(" ",d(13,9,"COMPANY_FORM.SUBMIT_EDIT")," ")}}function _t(n,u){if(n&1){let e=E();L(0),a(1,"button",56),v("click",function(){f(e);let i=c(5);return x(i.toggleEditCO2(i.co2Years[0]))}),l(2),p(3,"translate"),r(),k()}n&2&&(o(2),g(" ",d(3,1,"COMPANY_FORM.EDIT_BUTTON")," "))}function ut(n,u){if(n&1){let e=E();a(0,"button",57),v("click",function(){f(e);let i=c(5);return x(i.toggleEditCO2(i.co2Years[0]))}),l(1),p(2,"translate"),r(),a(3,"button",58),v("click",function(){f(e);let i=c(5);return x(i.deleteCO2(i.co2Years[0]))}),l(4),p(5,"translate"),r()}n&2&&(o(),g(" ",d(2,2,"COMPANY_FORM.CANCEL_EDIT_BUTTON")," "),o(3),g(" ",d(5,4,"COMPANY_FORM.DELETE_BUTTON")," "))}function gt(n,u){if(n&1){let e=E();a(0,"div",52)(1,"div")(2,"label",53),l(3),p(4,"translate"),r(),a(5,"input",54),N("ngModelChange",function(i){f(e);let s=c().$implicit;return A(s.editEmissions,i)||(s.editEmissions=i),x(i)}),r()(),a(6,"div")(7,"label",53),l(8),p(9,"translate"),r(),a(10,"input",54),N("ngModelChange",function(i){f(e);let s=c().$implicit;return A(s.editCompensations,i)||(s.editCompensations=i),x(i)}),r()(),a(11,"button",55),v("click",function(){f(e);let i=c().$implicit,s=c(5);return x(s.saveCO2(i))}),l(12),p(13,"translate"),r()()}if(n&2){let e=c().$implicit;o(3),_(d(4,5,"COMPANY_FORM.ISSUED_LABEL")),o(2),w("ngModel",e.editEmissions),o(3),_(d(9,7,"COMPANY_FORM.COMPENSATED_LABEL")),o(2),w("ngModel",e.editCompensations),o(2),g(" ",d(13,9,"COMPANY_FORM.SUBMIT_EDIT")," ")}}function ft(n,u){if(n&1){let e=E();L(0),a(1,"button",56),v("click",function(){f(e);let i=c().$implicit,s=c(5);return x(s.toggleEditCO2(i))}),l(2),p(3,"translate"),r(),k()}n&2&&(o(2),g(" ",d(3,1,"COMPANY_FORM.EDIT_BUTTON")," "))}function xt(n,u){if(n&1){let e=E();a(0,"button",57),v("click",function(){f(e);let i=c().$implicit,s=c(5);return x(s.toggleEditCO2(i))}),l(1),p(2,"translate"),r(),a(3,"button",58),v("click",function(){f(e);let i=c().$implicit,s=c(5);return x(s.deleteCO2(i))}),l(4),p(5,"translate"),r()}n&2&&(o(),g(" ",d(2,2,"COMPANY_FORM.CANCEL_EDIT_BUTTON")," "),o(3),g(" ",d(5,4,"COMPANY_FORM.DELETE_BUTTON")," "))}function Ct(n,u){if(n&1&&(a(0,"div",59)(1,"div",60),l(2),r(),C(3,gt,14,11,"div",41),a(4,"div",42)(5,"div",43)(6,"div",44),l(7),p(8,"translate"),r(),T(9,"canvas",61),r(),a(10,"div",43)(11,"div",44),l(12),p(13,"translate"),r(),T(14,"canvas",61),r(),a(15,"div",43)(16,"div",62),l(17),p(18,"number"),r(),a(19,"div",63),l(20),p(21,"translate"),r(),a(22,"div",64),l(23),p(24,"translate"),r()()(),a(25,"div",49)(26,"div",50),C(27,ft,4,3,"ng-container",24)(28,xt,6,6,"ng-template",null,1,F),r()()()),n&2){let e=u.$implicit,t=O(29),i=c(5);o(2),_(e.year),o(),m("ngIf",e.editMode),o(4),_(d(8,12,"COMPANY_FORM.ISSUED_LABEL")),o(2),m("id",e.emitidoRef),o(3),_(d(13,14,"COMPANY_FORM.COMPENSATED_LABEL")),o(2),m("id",e.compensadoRef),o(2),m("ngClass",i.getNetColorClass(e.totalEmissions,e.totalCompensations)),o(),g(" ",R(18,16,e.totalEmissions-e.totalCompensations,"1.0-0")," "),o(3),_(d(21,19,"COMPANY_FORM.TONS_CO2")),o(3),g(" ",R(24,21,"COMPANY_FORM.PREVIOUS_COMPENSATED_PERCENTAGE",Q(24,He,i.getCompensatedPercentage(e.totalEmissions,e.totalCompensations)))," "),o(4),m("ngIf",!e.editMode)("ngIfElse",t)}}function vt(n,u){if(n&1&&(a(0,"div")(1,"div",21)(2,"p",22),l(3),p(4,"translate"),r()(),a(5,"div",40)(6,"p",22),l(7),p(8,"translate"),r(),a(9,"p",22),l(10),r(),C(11,mt,14,11,"div",41),a(12,"div",42)(13,"div",43)(14,"div",44),l(15),p(16,"translate"),r(),T(17,"canvas",45),r(),a(18,"div",43)(19,"div",44),l(20),p(21,"translate"),r(),T(22,"canvas",45),r(),a(23,"div",43)(24,"div",44),l(25),p(26,"translate"),r(),a(27,"div",46),l(28),p(29,"number"),r(),a(30,"div",47),l(31),p(32,"translate"),r(),a(33,"div",48),l(34),p(35,"translate"),r()()(),a(36,"div",49)(37,"div",50),C(38,_t,4,3,"ng-container",24)(39,ut,6,6,"ng-template",null,1,F),r()()(),a(41,"div",21)(42,"p",22),l(43),p(44,"translate"),r()(),C(45,Ct,30,26,"div",51),r()),n&2){let e=O(40),t=c(4);o(3),_(d(4,17,"COMPANY.CO2_SECTION_TITLE")),o(4),_(d(8,19,"COMPANY.LAST_YEAR")),o(3),_(t.co2Years[0].year),o(),m("ngIf",t.co2Years[0].editMode),o(4),_(d(16,21,"COMPANY_FORM.ISSUED_LABEL")),o(2),m("id",t.co2Years[0].emitidoRef),o(3),_(d(21,23,"COMPANY_FORM.COMPENSATED_LABEL")),o(2),m("id",t.co2Years[0].compensadoRef),o(3),_(d(26,25,"COMPANY_FORM.NET_VALUE")),o(2),m("ngClass",t.getNetColorClass(t.co2Years[0].totalEmissions,t.co2Years[0].totalCompensations)),o(),g(" ",R(29,27,t.co2Years[0].totalEmissions-t.co2Years[0].totalCompensations,"1.0-0")," "),o(3),_(d(32,30,"COMPANY_FORM.TONS_CO2")),o(3),g(" ",R(35,32,"COMPANY_FORM.COMPENSATED_PERCENTAGE",Q(37,He,t.getCompensatedPercentage(t.co2Years[0].totalEmissions,t.co2Years[0].totalCompensations)))," "),o(4),m("ngIf",!t.co2Years[0].editMode)("ngIfElse",e),o(5),g("",d(44,35,"COMPANY.PREVIOUS_YEARS_TITLE")," "),o(2),m("ngForOf",t.co2Years.slice(1))}}function yt(n,u){if(n&1&&(a(0,"option",65),l(1),r()),n&2){let e=u.$implicit;m("value",e),o(),_(e)}}function ht(n,u){if(n&1){let e=E();L(0),C(1,vt,46,39,"div",26),a(2,"div",35)(3,"label",36),l(4),p(5,"translate"),r(),a(6,"select",37),N("ngModelChange",function(i){f(e);let s=c(3);return A(s.selectedYear,i)||(s.selectedYear=i),x(i)}),C(7,yt,2,2,"option",38),r(),T(8,"br"),a(9,"button",39),v("click",function(){f(e);let i=c(3);return x(i.addNewYear(i.selectedYear))}),l(10),p(11,"translate"),r()(),k()}if(n&2){let e=c(3);o(),m("ngIf",e.co2Years==null?null:e.co2Years.length),o(3),_(d(5,5,"COMPANY_FORM.ADD_YEAR_LABEL")),o(2),w("ngModel",e.selectedYear),o(),m("ngForOf",e.availableYears),o(3),g(" ",d(11,7,"COMPANY_FORM.ADD_YEAR_BUTTON")," ")}}function Et(n,u){if(n&1&&(a(0,"div"),C(1,ht,12,9,"ng-container",26),r()),n&2){let e=u.ngIf;o(),m("ngIf",e.role==="ADMIN")}}function bt(n,u){if(n&1){let e=E();a(0,"div",3)(1,"form",4),v("ngSubmit",function(){f(e);let i=c();return x(i.onSubmitCompany())}),a(2,"h1",5),l(3),p(4,"translate"),p(5,"translate"),r(),a(6,"div",6),T(7,"img",7),p(8,"translate"),a(9,"label",8)(10,"span",9),l(11,"photo_camera"),r(),a(12,"span"),l(13),p(14,"translate"),r(),a(15,"input",10),v("change",function(i){f(e);let s=c();return x(s.onCompanyFileSelected(i))}),r()()(),a(16,"div",11)(17,"div",12)(18,"label",13),l(19),p(20,"translate"),r(),T(21,"input",14),p(22,"translate"),r(),a(23,"div",12)(24,"label",15),l(25),p(26,"translate"),r(),T(27,"input",16),p(28,"translate"),r()(),a(29,"div",17)(30,"button",18),v("click",function(){f(e);let i=c();return x(i.cancel())}),l(31),p(32,"translate"),r(),a(33,"button",19),l(34),p(35,"translate"),p(36,"translate"),r()()(),a(37,"div",20)(38,"div",21)(39,"p",22),l(40),p(41,"translate"),r(),C(42,st,3,3,"button",23),r(),C(43,dt,2,1,"ul",24)(44,ct,3,3,"ng-template",null,0,F),r(),T(46,"hr",25),C(47,Et,2,1,"div",26),p(48,"async"),r()}if(n&2){let e=O(45),t=c();o(),m("formGroup",t.companyForm),o(2),g(" ",t.company.id?d(4,16,"COMPANY_FORM.TITLE_EDIT"):d(5,18,"COMPANY_FORM.TITLE_NEW")," "),o(4),U("alt",d(8,20,"COMPANY_FORM.TITLE_NEW")),m("src",t.previewImage||t.company.picture||"assets/logo-white.png",oe),o(6),_(d(14,22,"COMPANY_FORM.SELECT_IMAGE")),o(6),_(d(20,24,"COMPANY_FORM.NAME_LABEL")),o(2),U("placeholder",d(22,26,"COMPANY_FORM.NAME_PLACEHOLDER")),o(4),_(d(26,28,"COMPANY_FORM.ADDRESS_LABEL")),o(2),U("placeholder",d(28,30,"COMPANY_FORM.ADDRESS_PLACEHOLDER")),o(4),g(" ",d(32,32,"COMPANY_FORM.CANCEL_BUTTON")," "),o(3),g(" ",t.company.id?d(35,34,"COMPANY_FORM.SUBMIT_EDIT"):d(36,36,"COMPANY_FORM.SUBMIT_NEW")," "),o(6),_(d(41,38,"COMPANY.TREES_PLANTED_TITLE")),o(2),m("ngIf",t.isAdmin),o(),m("ngIf",t.companyTrees==null?null:t.companyTrees.length)("ngIfElse",e),o(4),m("ngIf",d(48,40,t.currentUser$))}}var Jt=(()=>{class n{constructor(e,t,i,s,y,M,Y,S,K){this.fb=e,this.companyService=t,this.companyCo2Service=i,this.route=s,this.router=y,this.userService=M,this.treeService=Y,this.dialog=S,this.authService=K,this.company={id:void 0,name:"",address:"",co2:[]},this.co2Years=[],this.chartsMap={},this.availableYears=[],this.currentUser$=this.userService.getCurrentUser$(),this.isAdmin=!1,this.companyTrees=[],this.destroy$=new ee,X.register(ke,Ue,$e,je)}ngOnInit(){this.initForm(),this.checkRole();let e=Number(this.route.snapshot.paramMap.get("id"));e&&(this.loadCompany(e),this.loadCompanyTrees(e)),this.userService.getUser().pipe(I(this.destroy$)).subscribe(t=>this.user=t)}ngOnDestroy(){Object.values(this.chartsMap).forEach(e=>e.destroy()),this.destroy$.next(),this.destroy$.complete()}initForm(){this.companyForm=this.fb.group({name:["",Ce.required],address:[""]})}checkRole(){let e=this.authService.currentUserRole;this.isAdmin=e==="ADMIN"}openAssignTreesModal(e){this.dialog.open(We,{width:"400px",data:{companyId:e}}).afterClosed().subscribe(i=>{i&&i.treeId&&this.treeService.assignTreeToCompany(i.treeId,e).subscribe(()=>{this.loadCompanyTrees(e)})})}openUnassignTreesModal(e){this.dialog.open(qe,{width:"400px",data:{companyId:this.company.id,treeTypeId:e.treeTypeId}}).afterClosed().subscribe(i=>{i?.updated&&this.loadCompanyTrees(this.company.id)})}loadCompanyTrees(e){this.treeService.getTreesByOwner(void 0,e).subscribe({next:t=>this.companyTrees=t,error:t=>console.error("Error cargando \xE1rboles de la compa\xF1\xEDa:",t)})}loadCompany(e){this.companyService.getCompanyById(e).pipe(I(this.destroy$)).subscribe(t=>{this.company=t,this.companyForm.patchValue({name:t.name,address:t.address}),this.previewImage=t.picture,this.prepareCO2Years(),this.updateAvailableYears()})}onCompanyFileSelected(e){let t=e.target.files[0];if(!t)return;this.selectedFile=t;let i=new FileReader;i.onload=()=>this.previewImage=i.result,i.readAsDataURL(t)}onSubmitCompany(){if(this.companyForm.invalid)return;let e=this.companyForm.value,t=[];if(!this.company.id)t.push(this.companyService.createCompany(e).pipe(V(i=>(console.error("Error creando empresa",i),P(null)))));else if(this.selectedFile&&t.push(this.companyService.updateCompanyPicture(this.company.id,this.selectedFile).pipe(V(i=>(console.error("Error actualizando imagen",i),P(this.company))))),(e.name!==this.company.name||e.address!==this.company.address)&&t.push(this.companyService.updateCompany(this.company.id,e).pipe(V(i=>(console.error("Error actualizando empresa",i),P(this.company))))),!t.length)return;te(t).pipe(I(this.destroy$)).subscribe(i=>{let s=i[i.length-1];s&&(this.company=s,this.companyForm.patchValue({name:s.name,address:s.address}),this.previewImage=s.picture,this.selectedFile=void 0,this.prepareCO2Years(),this.updateAvailableYears(),this.user&&(this.user.role==="ADMIN"?this.router.navigate(["/admin/companies"]):this.user.role==="COMPANY_ADMIN"?this.router.navigate(["/company"]):this.router.navigate(["/home"])))})}cancel(){this.user&&(this.user.role==="ADMIN"?this.router.navigate(["/admin/companies"]):this.user.role==="COMPANY_ADMIN"?this.router.navigate(["/company"]):this.router.navigate(["/home"]))}prepareCO2Years(){if(!this.company?.co2?.length){this.co2Years=[];return}let e=[...this.company.co2].filter(t=>t.year!==void 0).sort((t,i)=>i.year-t.year);this.co2Years=e.map(t=>({id:t.id,year:t.year,totalEmissions:t.totalEmissions||0,totalCompensations:t.totalCompensations||0,net:(t.totalEmissions||0)-(t.totalCompensations||0),emitidoRef:`emitido-${t.year}`,compensadoRef:`compensado-${t.year}`,netoRef:`neto-${t.year}`,editMode:!1,editEmissions:t.totalEmissions||0,editCompensations:t.totalCompensations||0})),setTimeout(()=>this.renderCO2Charts(),0)}toggleEditCO2(e){console.log("toggleEditCO2",e),e.editMode?e._backup&&(e.totalEmissions=e._backup.emissions,e.totalCompensations=e._backup.compensations):e._backup={emissions:e.totalEmissions,compensations:e.totalCompensations},e.editMode=!e.editMode,setTimeout(()=>this.renderCO2Charts(),0)}deleteCO2(e){console.log("deleteCO2",this.company.id,e.id),!(!this.company?.id||!e.id)&&this.companyCo2Service.delete(this.company.id,e.id).subscribe({next:()=>{this.co2Years=this.co2Years.filter(t=>t.id!==e.id),this.updateAvailableYears()},error:t=>{console.error("Error al eliminar CO2",t)}})}saveCO2(e){if(!this.company?.id)return;let t=e.editEmissions??0,i=e.editCompensations??0;e.net=t-i;let s={year:e.year,totalEmissions:t,totalCompensations:i};this.companyCo2Service.save(this.company.id,s).pipe(I(this.destroy$)).subscribe({next:y=>{this.loadCompany(this.company.id)},error:y=>console.error("Error guardando CO\u2082",y)})}addNewYear(e){if(!e||!this.company?.id)return;let t={year:e,totalEmissions:0,totalCompensations:0,net:0,emitidoRef:`emitido-${e}`,compensadoRef:`compensado-${e}`,netoRef:`neto-${e}`,editMode:!0,editEmissions:0,editCompensations:0},i={year:e,totalEmissions:0,totalCompensations:0};this.companyCo2Service.save(this.company.id,i).pipe(I(this.destroy$)).subscribe({next:s=>{t.id=s.id,this.co2Years.push(t),this.co2Years.sort((y,M)=>M.year-y.year),this.selectedYear=void 0,this.updateAvailableYears(),setTimeout(()=>this.renderCO2Charts(),0)},error:s=>console.error("Error guardando nuevo a\xF1o CO\u2082",s)})}createDonutChart(e,t,i,s){let y=e.getContext("2d");if(!y)return;this.chartsMap[e.id]&&this.chartsMap[e.id].destroy();let M={id:"centerText",beforeDraw:Ke=>{let{ctx:b,width:Z,height:B}=Ke;b&&(b.save(),b.font=`${B/100*20}px sans-serif`,b.fillStyle="#333",b.textBaseline="middle",b.fillText(`${t}`,Z/2-b.measureText(`${t}`).width/2,B/2-10),b.font=`${B/100*8}px sans-serif`,b.fillStyle="#666",b.fillText("Toneladas de CO\u2082",Z/2-b.measureText("Toneladas de CO\u2082").width/2,B/2+15),b.restore())}},Y=s>0?s:1,S=t/Y*100,K={datasets:[{data:[S,100-S],backgroundColor:[i,"#e0e0e0"],cutout:"75%",borderWidth:0}]},Je={responsive:!0,animation:{animateRotate:!0,animateScale:!0,duration:1e3},plugins:{legend:{display:!1},tooltip:{enabled:!1}}};this.chartsMap[e.id]=new X(y,{type:"doughnut",data:K,options:Je,plugins:[M]})}renderCO2Charts(){Object.values(this.chartsMap).forEach(t=>t.destroy()),this.chartsMap={};let e=["emitidoRef","compensadoRef","netoRef"];this.co2Years.forEach((t,i)=>{let s=i===0?200:80;e.forEach(y=>{let M=document.getElementById(t[y]);if(!M)return;M.width=s,M.height=s;let Y=y==="emitidoRef"?t.totalEmissions:y==="compensadoRef"?t.totalCompensations:t.net,S=y==="emitidoRef"?"#fc4d03ff":y==="compensadoRef"?"#89de8cff":"#2c80c5cf";this.createDonutChart(M,Y,S,t.totalEmissions||1)})})}updateAvailableYears(){let e=new Date().getFullYear(),t=this.co2Years.map(i=>i.year);this.availableYears=[];for(let i=2020;i<=e;i++)t.includes(i)||this.availableYears.push(i);this.availableYears.sort((i,s)=>s-i)}getNetColorClass(e,t){let i=e-t,s=e>0?i/e:1;return s<.5?"net-yellow":s<=1?"net-red":"net-green"}getCompensatedPercentage(e,t){return e?(t/e*100).toFixed(0):"0"}static{this.\u0275fac=function(t){return new(t||n)(h(Ae),h(Le),h(ze),h(se),h(le),h(_e),h(J),h(De),h(me))}}static{this.\u0275cmp=D({type:n,selectors:[["app-company-form"]],standalone:!0,features:[j],decls:1,vars:1,consts:[["noCompanyTrees",""],["editModeButtons",""],["class","w-full max-w-full mx-auto bg-white p-6 rounded-2xl shadow-lg",4,"ngIf"],[1,"w-full","max-w-full","mx-auto","bg-white","p-6","rounded-2xl","shadow-lg"],[3,"ngSubmit","formGroup"],[1,"text-2xl","font-bold","mb-6","text-center"],[1,"md:col-span-2","flex","flex-col","items-center","mb-6"],[1,"w-24","h-24","rounded-full","shadow-lg","mb-2","object-cover",3,"src","alt"],[1,"cursor-pointer","bg-gray-200","hover:bg-gray-300","p-2","rounded-full","flex","items-center","gap-2"],[1,"material-icons"],["type","file","accept","image/*","hidden","",3,"change"],[1,"flex","flex-col","md:flex-row","gap-4","mb-6"],[1,"flex-1"],["for","name",1,"block","text-gray-700","font-medium","mb-1"],["id","name","type","text","formControlName","name","required","",1,"w-full","rounded-xl","border","border-gray-300","px-4","py-2","shadow-sm","focus:outline-none","focus:ring-2","focus:ring-green-500","focus:border-transparent","transition",3,"placeholder"],["for","address",1,"block","text-gray-700","font-medium","mb-1"],["id","address","type","text","formControlName","address",1,"w-full","rounded-xl","border","border-gray-300","px-4","py-2","shadow-sm","focus:outline-none","focus:ring-2","focus:ring-green-500","focus:border-transparent","transition",3,"placeholder"],[1,"flex","justify-end","gap-4","mt-6"],["type","button",1,"flex-1","bg-gray-300","text-gray-700","py-3","rounded-xl","hover:bg-gray-400","transition",3,"click"],["type","submit",1,"flex-1","bg-green-600","text-white","py-3","rounded-xl","hover:bg-green-700","disabled:opacity-50","transition"],[1,"mt-4","w-full","text-left"],[1,"flex","justify-between","items-center","mb-2"],[1,"font-semibold","text-gray-700"],["type","button","class","bg-green-200 text-green-800 px-3 py-1 rounded-full hover:bg-green-300 transition text-sm",3,"click",4,"ngIf"],[4,"ngIf","ngIfElse"],[1,"my-6"],[4,"ngIf"],["type","button",1,"bg-green-200","text-green-800","px-3","py-1","rounded-full","hover:bg-green-300","transition","text-sm",3,"click"],["class","flex justify-between border-b py-1",4,"ngFor","ngForOf"],[1,"flex","justify-between","border-b","py-1"],[1,"block","font-semibold"],[1,"text-sm","text-gray-500"],["type","button","class","bg-red-200 text-red-800 px-3 py-1 rounded-full hover:bg-red-300 transition text-sm",3,"click",4,"ngIf"],["type","button",1,"bg-red-200","text-red-800","px-3","py-1","rounded-full","hover:bg-red-300","transition","text-sm",3,"click"],[1,"text-gray-500","italic"],[1,"border","p-4","rounded-xl","shadow-sm","text-center","mt-6","bg-gray-50"],["for","newYear",1,"block","text-gray-700","font-medium","mb-2"],["id","newYear","name","newYear",1,"w-32","rounded-xl","border","border-gray-300","px-3","py-2","shadow-sm","focus:outline-none","focus:ring-2","focus:ring-green-500","focus:border-transparent","transition","mb-2",3,"ngModelChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],[1,"w-32","bg-green-600","text-white","py-2","rounded-xl","hover:bg-green-700","transition","mt-2",3,"click"],[1,"mb-8","border","p-4","rounded-xl","shadow-sm","bg-gray-50"],["class","flex flex-wrap gap-4 mb-4 justify-center",4,"ngIf"],[1,"flex","flex-wrap","gap-4","justify-center","items-center"],[1,"text-center"],[1,"font-medium"],[1,"donut-large",3,"id"],[1,"text-4xl","font-bold",3,"ngClass"],[1,"text-gray-600","text-sm"],[1,"text-xs","text-gray-500","mt-1"],[1,"mt-5","flex","justify-end","mb-2"],[1,"flex","justify-center","mt-4","gap-4","w-full"],["class","mb-6 border p-4 rounded-xl shadow-sm bg-gray-50",4,"ngFor","ngForOf"],[1,"flex","flex-wrap","gap-4","mb-4","justify-center"],[1,"block","text-gray-700","font-medium","mb-1"],["type","number",1,"w-32","rounded-xl","border","border-gray-300","px-3","py-1","shadow-sm","focus:outline-none","focus:ring-2","focus:ring-green-500","focus:border-transparent","transition",3,"ngModelChange","ngModel"],[1,"px-4","py-2","rounded-xl","bg-blue-600","text-white","hover:bg-blue-700","transition",3,"click"],[1,"bg-green-600","text-white","py-3","px-6","rounded-xl","hover:bg-green-700","transition","w-1/2",3,"click"],[1,"bg-gray-300","text-gray-700","py-3","px-6","rounded-xl","hover:bg-gray-400","transition","flex-1",3,"click"],[1,"bg-red-600","text-white","py-3","px-6","rounded-xl","hover:bg-red-700","transition","flex-1",3,"click"],[1,"mb-6","border","p-4","rounded-xl","shadow-sm","bg-gray-50"],[1,"w-16","font-bold"],[1,"donut-small",3,"id"],[1,"font-semibold","text-lg",3,"ngClass"],[1,"text-sm","text-gray-600"],[1,"text-xs","text-gray-500"],[3,"value"]],template:function(t,i){t&1&&C(0,bt,49,42,"div",2),t&2&&m("ngIf",i.company)},dependencies:[q,re,$,W,G,ae,Ne,Ee,Ie,Oe,xe,be,Se,ve,ye,we,he,Fe,Te,Me,ge,fe,Ye,Re,Be,ue,H,z],encapsulation:2})}}return n})();export{Jt as CompanyFormComponent};
